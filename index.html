<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>❤️ Тайное послание для тебя</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Marck+Script&family=Pacifico&family=Poiret+One&family=Playfair+Display:wght@400;700&family=Raleway:wght@300;400;600&family=Dancing+Script:wght@400;700&family=Great+Vibes&family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        :root {
            --primary: #ff3366;
            --secondary: #ff66a3;
            --accent: #ff99cc;
            --light: #fff0f5;
            --dark: #2a0f1a;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --purple: #b399ff;
            --blue: #66ccff;
        }

        body {
            background: linear-gradient(135deg, #0a0a2a 0%, #1a0a2a 50%, #2a0a1a 100%);
            color: white;
            font-family: 'Raleway', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
        }



        /* ЭКРАН ПАРОЛЯ */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 100;
        }

        #password-screen {
            background: radial-gradient(circle at center, rgba(255, 51, 102, 0.1) 0%, rgba(26, 10, 42, 0.95) 100%);
        }

        .password-container {
            background: rgba(255, 255, 255, 0.12);
            border-radius: 30px;
            padding: 40px 30px;
            max-width: 400px;
            width: 100%;
            border: 2px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 25px 70px rgba(255, 51, 102, 0.35),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .heart-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") center/contain no-repeat;
            animation: heartbeat 1.2s ease-in-out infinite;
            filter: drop-shadow(0 5px 15px rgba(255, 51, 102, 0.6));
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(1.05); }
            75% { transform: scale(1.15); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .password-input {
            width: 100%;
            padding: 18px 20px;
            font-size: 20px;
            background: rgba(255, 255, 255, 0.18);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            color: white;
            text-align: center;
            margin: 25px 0;
            font-family: 'Dancing Script', cursive;
            transition: all 0.3s;
            letter-spacing: 2px;
            -webkit-appearance: none;
            appearance: none;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(255, 51, 102, 0.6);
            background: rgba(255, 255, 255, 0.25);
        }

        .submit-btn {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 22px;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Great Vibes', cursive;
            transition: all 0.3s;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 51, 102, 0.5);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        /* ОСНОВНОЙ ЭКРАН */
        #main-screen {
            display: none;
        }

        .header {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
            background: linear-gradient(to bottom, rgba(10, 10, 42, 0.95), transparent);
        }

        .logo {
            font-family: 'Great Vibes', cursive;
            font-size: 28px;
            color: var(--primary);
            text-shadow: 0 2px 10px rgba(255, 51, 102, 0.5);
        }

        .page-indicator {
            display: flex;
            gap: 8px;
        }

        .indicator-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s;
        }

        .indicator-dot.active {
            background: var(--primary);
            transform: scale(1.3);
            box-shadow: 0 0 10px var(--primary);
        }

        /* КАРУСЕЛЬ */
        .carousel {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 100px 20px 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page.active {
            transform: translateX(0);
            opacity: 1;
        }

        .page.prev {
            transform: translateX(-100%);
        }

        .page-content {
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* СТРАНИЦА 1: ОТКРЫТКА - ИСПРАВЛЕНА */
        .card-container {
            perspective: 2000px;
            width: 100%;
            max-width: 320px;
            height: 450px;
            cursor: pointer;
            margin: 0 auto;
        }

        @media (max-width: 480px) {
            .card-container {
                max-width: 280px;
                height: 400px;
            }
        }

        .card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card.open {
            transform: rotateY(-180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }

        .card-front {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .card-back {
            background: white;
            color: var(--dark);
            transform: rotateY(180deg);
            overflow-y: auto;
        }

        .open-instruction {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Caveat', cursive;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.9);
            animation: float 3s ease-in-out infinite;
            white-space: nowrap;
        }

        @keyframes float {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        /* СТРАНИЦА 2: БОЛТ */
        .shield-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 20px auto;
            aspect-ratio: 1 / 1; /*Квадратная форма*/
        }

        @media (max-width: 480px) {
            .shield-container {
                width: 250px;
                height: 250px;
            }
        }

        .shield {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--silver), #e0e0e0);
            border-radius: 50%;
            box-shadow:
                0 0 0 10px rgba(255, 255, 255, 0.1),
                inset 0 0 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 15px solid var(--gold);
            transition: transform 0.5s ease;
        }

        .bolt-hole {
            position: absolute;
            width: 100px;
            height: 100px;
            background: linear-gradient(45deg, #1a0a2a, #2a1a3a);
            border-radius: 50%;
            border: 5px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .bolt {
            width: 70px;
            height: 70px;
            background: conic-gradient(var(--gold), #ffcc00, var(--gold));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: grab;
            touch-action: none;
            box-shadow:
                0 5px 15px rgba(0, 0, 0, 0.3),
                inset 0 2px 5px rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 3;
            transition: transform 0.1s;
        }

        .bolt-direction {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: var(--gold);
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateX(-50%) rotate(0deg); }
            100% { transform: translateX(-50%) rotate(-360deg); }
        }

        .message-under-shield {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border-radius: 50%;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.5s ease;
            font-family: 'Dancing Script', cursive;
            font-size: 24px;
            color: white;
            text-align: center;
            padding: 20px;
            z-index: 1;
        }

        .message-under-shield.show {
            opacity: 1;
            transform: scale(1);
        }

        .shield.fall-off {
            transform: translateY(100vh) rotate(360deg);
            opacity: 0;
            transition: transform 1.5s ease, opacity 1.5s ease;
        }

        /* СТРАНИЦА 3: СТИРАНИЕ */
        .scratch-container {
            width: 320px;
            height: 320px;
            position: relative;
            margin: 20px auto;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 480px) {
            .scratch-container {
                width: 280px;
                height: 280px;
            }
        }

        .scratch-canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            cursor: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><circle cx="16" cy="16" r="14" fill="white" opacity="0.8"/></svg>') 16 16, crosshair;
            touch-action: none;
            z-index: 2;
        }

        .scratch-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            filter: blur(15px);
            transition: filter 0.5s;
        }

        .scratch-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 0;
            transition: opacity 1s;
        }

        .scratch-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Marck Script', cursive;
            font-size: 28px;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            text-align: center;
            z-index: 3;
        }

        .scratch-percent {
            margin-top: 15px;
            font-family: 'Caveat', cursive;
            font-size: 22px;
            color: var(--primary);
        }

        .scratch-message {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            font-family: 'Dancing Script', cursive;  /* красивый рукописный шрифт */
            font-size: clamp(24px, 6vw, 36px);       /* адаптивный размер */
            color: #fff;
            text-shadow: 2px 2px 8px rgba(241, 234, 234, 0.7);
            background: linear-gradient(135deg, #f6dc76, #f6e895);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            z-index: 1;                               /* как у старого изображения */
            box-sizing: border-box;
            pointer-events: none;                      /* чтобы не мешать рисованию */
            filter: drop-shadow(0 0 10px rgba(255, 92, 131, 0.8));
        }

        /* СТРАНИЦА 4: ВСТРЯХНУТЬ - ИСПРАВЛЕНА */
        .shake-container {
            width: 300px;
            height: 300px;
            position: relative;
            margin: 20px auto;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .shake-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            filter: blur(20px);
            transition: filter 0.3s;
        }

        /* Замените текущую clip-path у .shake-overlay на это */
        .shake-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            transition: clip-path 0.35s ease, opacity 0.35s ease, transform 0.3s ease;
            /* начальный формат inset — согласованный с JS */
            /*clip-path: inset(50% 50% 50% 50%);*/
            pointer-events: none; /* чтобы оверлей не блокировал кнопки (если нужно) */
            z-index: 2;
        }


        .shake-button {
            margin-top: 30px;
            padding: 15px 40px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 50px;
            color: white;
            font-family: 'Pacifico', cursive;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .shake-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 51, 102, 0.4);
        }


        @keyframes romanticGlow {
            0% { text-shadow: 0 0 10px #ffb6c1, 0 0 20px #ff69b4; }
            50% { text-shadow: 0 0 20px #ff69b4, 0 0 30px #ffb6c1; }
            100% { text-shadow: 0 0 10px #ffb6c1, 0 0 20px #ff69b4; }
        }

        .shake-message {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 20px;
            font-family: 'Dancing Script', cursive;
            font-size: clamp(24px, 6vw, 36px);
            font-weight: bold;
            color: #d43f7a;  /* насыщенный розовый */
            background-color: #fff0f5;  /* очень бледный розовый */
            background-image: repeating-linear-gradient(45deg, rgba(255, 182, 193, 0.1) 0px, rgba(255, 182, 193, 0.1) 10px, transparent 10px, transparent 20px);
            text-shadow: 2px 2px 10px rgba(255, 255, 255, 0.8);
            box-shadow: inset 0 0 30px rgba(255, 182, 193, 0.3); /* внутреннее свечение */
            z-index: 1;
            transition: filter 0.3s ease;
            filter: blur(20px);
            animation: romanticGlow 3s infinite ease-in-out;
        }






        /* СТРАНИЦА 5: ПАЗЛ - ИСПРАВЛЕН */
        .puzzle-area {
            width: 320px;
            height: 320px;
            border-radius: 12px;
            background: linear-gradient(180deg, #fff3f6, #fff);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 6px;
            padding: 6px;
            margin: 20px auto;
        }


        @media (max-width: 480px) {
            .puzzle-area {
                width: 280px;
                height: 280px;
            }
        }

        .puzzle-piece {
            background-size: cover;
            border-radius: 8px;
            cursor: grab;
            transition: transform 0.2s;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .puzzle-piece:active {
            cursor: grabbing;
            transform: scale(1.05);
            z-index: 10;
        }
        .puzzle-piece.selected {
            border: 3px solid gold;
            transform: scale(1.02);
            z-index: 10;
        }
        /* Для очень узких экранов делаем пазл ещё меньше, чтобы кусочки были крупнее */
        @media (max-width: 360px) {
            .puzzle-area {
                width: 240px;
                height: 240px;
            }
        }

        /* СТРАНИЦА 6: ГАЛЕРЕЯ */
        .gallery-container {
            width: 100%;
            max-width: 400px;
            height: 400px;
            position: relative;
            margin: 20px auto;
            overflow: hidden;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        }

        @media (max-width: 480px) {
            .gallery-container {
                height: 350px;
            }
        }

        .gallery-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
            border-radius: 20px;
        }

        .gallery-slide.active {
            opacity: 1;
            transform: scale(1);
        }

        .gallery-nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .gallery-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .gallery-dot.active {
            background: var(--primary);
            transform: scale(1.5);
            box-shadow: 0 0 15px var(--primary);
        }

        /* СТРАНИЦА 7: СЕРДЕЧНЫЙ ВЗРЫВ - ИСПРАВЛЕН */
        .hearts-container {
            width: 300px;
            height: 300px;
            position: relative;
            margin: 20px auto;
        }

        .main-heart {
            width: 120px;
            height: 120px;
            background: var(--primary);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            clip-path: polygon(50% 15%, 80% 0, 100% 35%, 50% 100%, 0 35%, 20% 0);
            cursor: pointer;
            transition: all 0.3s;
            animation: pulse 2s infinite;
            box-shadow: 0 10px 30px rgba(255, 51, 102, 0.4);
        }

        .main-heart:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }

        .main-heart:active {
            transform: translate(-50%, -50%) scale(0.95);
        }

        .tap-counter {
            margin-top: 20px;
            font-family: 'Caveat', cursive;
            font-size: 24px;
            color: var(--primary);
        }

        /* СТРАНИЦА 8: ФИНАЛ */
        .final-message {
            max-width: 400px;
            margin: 0 auto;
        }

        .final-heart {
            font-size: 80px;
            margin: 20px 0;
            animation: heartbeat 1.2s infinite;
        }

        .download-btn {
            margin-top: 30px;
            padding: 15px 40px;
            background: linear-gradient(45deg, var(--primary), var(--purple));
            border: none;
            border-radius: 50px;
            color: white;
            font-family: 'Pacifico', cursive;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;

        }

        .download-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 51, 102, 0.4);
        }

        /* НАВИГАЦИЯ */
        .nav-buttons {
            position: fixed;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 0 20px;
            z-index: 50;
        }

        .nav-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        /* Для финальной страницы разрешаем прокрутку
        #page8 .page-content {
            overflow-y: auto;
            justify-content: flex-start;
            padding-top: 20px;
            padding-bottom: 100px;
        }*/

        /* Уменьшаем отступы на очень маленьких экранах */
        @media (max-width: 480px) and (max-height: 700px) {
            #page8 .final-message {
                padding-bottom: 30px;
            }
            #page8 .final-heart {
                font-size: 60px;
            }
            #page8 .download-btn {
                margin-top: 20px;
                padding: 12px 30px;
                font-size: 16px;
            }
        }

        /* КОНФЕТТИ */
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            top: -10px;
            opacity: 0;
        }

        /* АНИМАЦИЯ ПАДЕНИЯ */
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        /* АДАПТИВНОСТЬ */
        @media (max-width: 768px) {
            .card-container {
                width: 280px;
                height: 400px;
            }

            .shield-container,
            .scratch-container,
            .shake-container {
                width: 280px;
                height: 280px;
            }

            .page {
                padding: 90px 15px 120px;
            }

            .nav-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .password-container {
                padding: 30px 20px;
            }

            .password-input {
                font-size: 18px;
                padding: 15px;
            }

            .submit-btn {
                font-size: 20px;
                padding: 15px 30px;
            }

            .page {
                padding: 80px 15px 110px;
            }
        }

        /* Прокрутка для финальной страницы только на маленьких экранах (по высоте) */
@media (max-height: 700px) {
    #page8 .page-content {
        overflow-y: auto;
        justify-content: flex-start;
        padding-top: 20px;
        padding-bottom: 100px;
    }
}


    </style>
</head>
<body>
    <!-- ПАНЕЛЬ ЛОГОВ -->


    <!-- ЭКРАН ПАРОЛЯ -->
    <div id="password-screen" class="screen">
        <div class="password-container">
            <div class="heart-icon"></div>
            <h1 style="font-family: 'Great Vibes', cursive; font-size: 36px; margin-bottom: 10px; color: var(--primary); text-shadow: 0 2px 10px rgba(255, 51, 102, 0.5);">
                Для Тебя!
            </h1>
            <p style="margin-bottom: 20px; color: rgba(255, 255, 255, 0.9); font-family: 'Caveat', cursive; font-size: 22px;">
                Открой тайное послание...
            </p>
            <input type="text" id="password-input" class="password-input" placeholder="Нажми сюда и введи код...">
            <button id="submit-btn" class="submit-btn">Открыть сердце</button>
            <p style="margin-top: 20px; font-size: 16px; color: rgba(255, 255, 255, 0.6);">
                Подсказка: плюшевая игрушка, в которой я увидел тебя (PS: белый и пушистый)
            </p>
        </div>
    </div>

    <!-- ОСНОВНОЙ ЭКРАН -->
    <div id="main-screen" class="screen">
        <div class="header">
            <div class="logo">Для любимой ❤️</div>
            <div class="page-indicator" id="page-indicator">
                <div class="indicator-dot active"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
            </div>
        </div>

        <div class="carousel">
            <!-- СТРАНИЦА 1: ОТКРЫТКА -->
            <div class="page active" id="page1">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 30px; color: var(--primary);">
                        Переверни меня...
                    </h2>
                    <div class="card-container">
                        <div class="card" id="card">
                            <div class="card-front">
                                <div style="font-family: 'Dancing Script', cursive; font-size: 28px; margin-bottom: 10px;">
                                    Диана ,
                                </div>
                                <!--<div style="font-family: 'Caveat', cursive; font-size: 18px; opacity: 0.9;">
                                    Нажми, чтобы открыть послание...
                                </div>-->
                                <div class="open-instruction">Нажми на меня</div>
                            </div>
                            <div class="card-back">
                                <div style="font-family: 'Great Vibes', cursive; font-size: 30px; color: var(--primary); margin-bottom: 15px;">
                                    Поздравляю тебя<br>С 14 февраля!<br>Днём всех влюблённых!
                                </div>
                                <div style="font-family: 'Caveat', cursive; font-size: 20px; color: #666; line-height: 1.5; margin-bottom: 15px;">
                                    Эта открытка — лишь маленькая часть приятностей, которые только начинаются...
                                </div>
                                <div style="font-family: 'Caveat', cursive; font-size: 18px; color: #999; line-height: 1.4;">
                                    Листай дальше =>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 30px; font-family: 'Caveat', cursive; font-size: 18px; color: rgba(255, 255, 255, 0.7);">
                        Нажми на открытку, чтобы продолжить
                    </div>
                </div>
            </div>

            <!-- СТРАНИЦА 2: БОЛТ -->
            <div class="page" id="page2">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 20px; color: var(--primary);">
                        Открути колёсико
                    </h2>
                    <p style="font-family: 'Caveat', cursive; font-size: 20px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
                        Покрути жёлтый кружок против часовой стрелки, чтобы снять защитный щит
                    </p>
                    <div class="shield-container">
                        <div class="shield" id="shield">
                            <div class="bolt-hole">
                                <div class="bolt-direction">↺</div>
                                <div class="bolt" id="bolt"></div>
                            </div>
                        </div>
                        <div class="message-under-shield" id="message-under-shield">
                            Ты смогла!<br>Теперь я открыт для тебя полностью ❤️
                        </div>
                    </div>
                    <!--<div style="margin-top: 20px; font-family: 'Caveat', cursive; font-size: 18px; color: rgba(255, 255, 255, 0.7);">
                        Крути болт пальцем против часовой стрелки
                    </div>-->
                </div>
            </div>

            <!-- СТРАНИЦА 3: СТИРАНИЕ -->
            <div class="page" id="page3">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 20px; color: var(--primary);">
                        Сотри туман
                    </h2>
                    <p style="font-family: 'Caveat', cursive; font-size: 20px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
                        Проведи пальцем, чтобы стереть размытие
                    </p>
                    <div class="scratch-container">
                        <div class="scratch-message" id="scratch-message">
                            Каким бы не казалось будущее — знай, я всегда рядом!
                        </div>
                        <div class="scratch-overlay" id="scratch-overlay"></div>
                        <div class="scratch-text">Сотри меня...</div>
                        <canvas class="scratch-canvas" id="scratch-canvas"></canvas>
                    </div>
                    <div class="scratch-percent" id="scratch-percent">Стерто: 0%</div>
                </div>
            </div>

            <!-- СТРАНИЦА 4: ВСТРЯХНУТЬ -->
            <div class="page" id="page4">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 20px; color: var(--primary);">
                        Стряхни тайну
                    </h2>
                    <p style="font-family: 'Caveat', cursive; font-size: 20px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
                        Потряси телефон или нажми кнопку
                    </p>
                    <div class="shake-container">
                    <div class="shake-message" id="shake-message">
                        Твоя улыбка — теплее солнца в яркий день!
                    </div>
                    <div class="shake-overlay" id="shake-overlay"></div>
                </div>
                    <button class="shake-button" id="shake-button" >Стряхнуть размытие (0/5)</button>
                    <p style="margin-top: 20px; font-family: 'Caveat', cursive; font-size: 18px; color: rgba(255, 255, 255, 0.7);">
                        На телефоне: просто потряси устройство
                    </p>
                </div>
            </div>

            <!-- СТРАНИЦА 5: ПАЗЛ -->
            <div class="page" id="page5">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 20px; color: var(--primary);">
                        Собери сердечко
                    </h2>
                    <p style="font-family: 'Caveat', cursive; font-size: 20px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
                        Перетащи фрагменты на место, чтобы собрать сердце
                    </p>
                    <div class="puzzle-area" id="puzzle"></div>
                    <p style="margin-top: 20px; font-family: 'Caveat', cursive; font-size: 18px; color: var(--primary);">
                        Нажми на кусочек или перетащи его!
                    </p>
                </div>
            </div>

            <!-- СТРАНИЦА 6: ГАЛЕРЕЯ -->
            <div class="page" id="page6">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 20px; color: var(--primary);">
                        Наши моменты
                    </h2>
                    <p style="font-family: 'Caveat', cursive; font-size: 20px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
                        Листай фото внизу
                    </p>
                    <div class="gallery-container" id="gallery-container">
                        <div class="gallery-slide active" style="background-image: url('https://plus.unsplash.com/premium_photo-1670445287762-372300cdcb77?q=80&w=687&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');">
                            <div style="background: rgba(0,0,0,0.6); padding: 15px; border-radius: 15px; margin-top: 250px;">
                                <div style="font-family: 'Caveat', cursive; font-size: 22px; color: white;">Наша первая встреча</div>
                            </div>
                        </div>
                        <div class="gallery-slide" style="background-image: url('https://images.unsplash.com/photo-1569599551613-0168197f15d3?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');">
                            <div style="background: rgba(0,0,0,0.6); padding: 15px; border-radius: 15px; margin-top: 250px;">
                                <div style="font-family: 'Caveat', cursive; font-size: 22px; color: white;">Самые теплые моменты</div>
                            </div>
                        </div>
                        <div class="gallery-slide" style="background-image: url('https://images.unsplash.com/photo-1533601017-dc61895e03c0?q=80&w=1170&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D');">
                            <div style="background: rgba(0,0,0,0.6); padding: 15px; border-radius: 15px; margin-top: 250px;">
                                <div style="font-family: 'Caveat', cursive; font-size: 22px; color: white;">Будущее с тобой</div>
                            </div>
                        </div>
                    </div>
                    <div class="gallery-nav" id="gallery-nav"></div>
                </div>
            </div>

            <!-- СТРАНИЦА 7: СЕРДЕЧНЫЙ ВЗРЫВ -->
            <div class="page" id="page7">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 20px; color: var(--primary);">
                        Сердечный взрыв
                    </h2>
                    <p style="font-family: 'Caveat', cursive; font-size: 20px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
                        Нажимай на сердце, чтобы наполнить его любовью
                    </p>
                    <div class="hearts-container" id="hearts-container">
                        <div class="main-heart" id="main-heart"></div>
                    </div>
                    <div class="tap-counter" id="tap-counter">
                        Нажми на сердце! Осталось: 10
                    </div>
                </div>
            </div>

            <!-- СТРАНИЦА 8: ФИНАЛ -->
            <div class="page" id="page8">
                <div class="page-content">
                    <h2 style="font-family: 'Great Vibes', cursive; font-size: 42px; margin-bottom: 20px; color: var(--primary);">
                        From me, to you
                    </h2>
                    <div class="final-message">
                        <div class="final-heart">❤️</div>
                        <div style="font-family: 'Dancing Script', cursive; font-size: 28px; margin-bottom: 15px; color: white;">
                            С Днём Святого Валентина!
                        </div>
                        <div style="font-family: 'Caveat', cursive; font-size: 24px; line-height: 1.6; color: rgba(255, 255, 255, 0.9); margin-bottom: 30px;">
                            Ты — одна из лучших неожиданных вещей в моей жизни.<br>
                            Рядом с тобой всё как будто проще и уютнее.<br><br>Спасибо, что ты есть!
                        </div>

                        <button class="download-btn" id="downloadBtn" >
                            Скачать открытку ❤️
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- НАВИГАЦИЯ -->
        <div class="nav-buttons">
            <button class="nav-btn" id="prev-btn">←</button>
            <button class="nav-btn" id="next-btn">→</button>
        </div>
    </div>

    <!-- КОНФЕТТИ -->
    <div class="confetti" id="confetti"></div>

    <script>
        // ==================== СИСТЕМА ЛОГИРОВАНИЯ ====================


        // КОНФИГУРАЦИЯ
        const CONFIG = {
            PASSWORD: ['кролик', 'Кролик', 'заяц', 'Заяц', 'зайчик', 'Зайчик', 'кроль', 'Кроль'],
            TOTAL_PAGES: 8,
            SCRATCH_THRESHOLD: 50,
            SHAKE_ACTIONS_REQUIRED: 5,
            HEART_TAPS_REQUIRED: 10
        };

        // СОСТОЯНИЕ
        let currentPage = 0;
        let isDraggingPuzzle = false;
        let scratchPercent = 0;
        let heartTaps = 0;
        let shakeActions = 0;
        let pageCompleted = {
            1: false, 2: false, 3: false, 4: false,
            5: false, 6: true, 7: false, 8: true
        };

        // ЭЛЕМЕНТЫ
        const passwordScreen = document.getElementById('password-screen');
        const mainScreen = document.getElementById('main-screen');
        const passwordInput = document.getElementById('password-input');
        const submitBtn = document.getElementById('submit-btn');
        const pages = document.querySelectorAll('.page');
        const indicatorDots = document.querySelectorAll('.indicator-dot');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // ИНИЦИАЛИЗАЦИЯ
        function init() {


            // Фокус на поле ввода (с задержкой для мобильных)
            setTimeout(() => {
                passwordInput.focus();

            }, 500);

            // Обработчики пароля
            submitBtn.addEventListener('click', checkPassword);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkPassword();
            });

            // Обработчики навигации
            prevBtn.addEventListener('click', goToPrevPage);
            nextBtn.addEventListener('click', goToNextPage);

            // Инициализация свайпов
            initSwipe();

            // Запрос разрешения на гироскоп для iOS
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(response => {
                    if (response === 'granted') {

                    }
                });
            }


        }

        // ПАРОЛЬ
        function checkPassword() {
            const input = passwordInput.value.trim().toLowerCase();


            if (CONFIG.PASSWORD.map(p => p.toLowerCase()).includes(input)) {

                showSuccessAnimation();
                setTimeout(() => {
                    passwordScreen.style.display = 'none';
                    mainScreen.style.display = 'flex';
                    showPage(0);
                    createConfetti();
                    playSound('success');
                }, 1500);
            } else {

                showErrorAnimation();
            }
        }

        function showSuccessAnimation() {
            submitBtn.style.background = 'linear-gradient(45deg, #00ff88, #00cc66)';
            submitBtn.innerHTML = '✓ Успех!';

            const heart = document.querySelector('.heart-icon');
            heart.style.background = 'linear-gradient(45deg, #00ff88, #00cc66)';

            createConfettiAtElement(passwordScreen);
        }

        function showErrorAnimation() {
            const input = passwordInput;
            const submit = submitBtn;
            const heart = document.querySelector('.heart-icon');

            // Красный цвет для кнопки и сердечка
            submit.style.background = 'linear-gradient(45deg, #ff3366, #ff0000)';
            submit.innerHTML = '✗ Неверный код';
            heart.style.background = 'linear-gradient(45deg, #ff3366, #ff0000)';

            // Тряска поля ввода
            input.style.animation = 'shake 0.5s';
            input.style.borderColor = '#ff3366';
            input.style.boxShadow = '0 0 30px rgba(255, 51, 102, 0.6)';

            // Возврат к исходному состоянию через 1.5 секунды
            setTimeout(() => {
                submit.style.background = 'linear-gradient(45deg, var(--primary), var(--secondary))';
                submit.innerHTML = 'Открыть сердце';
                heart.style.background = 'linear-gradient(45deg, var(--primary), var(--secondary))';
                input.style.animation = '';
                input.style.borderColor = 'rgba(255, 255, 255, 0.4)';
                input.style.boxShadow = 'none';
            }, 1500);

            playSound('error');
        }

        // НАВИГАЦИЯ - ИСПРАВЛЕНО: НЕТ АВТОПЕРЕХОДА
        function initSwipe() {
            let startX = 0;
            let startY = 0;
            let isSwiping = false;

            document.addEventListener('touchstart', (e) => {
                if (isDraggingPuzzle) return;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isSwiping = true;
            });

            document.addEventListener('touchmove', (e) => {
                if (!isSwiping || isDraggingPuzzle) return;
                e.preventDefault();
            });

            document.addEventListener('touchend', (e) => {
                if (!isSwiping || isDraggingPuzzle) return;
                isSwiping = false;

                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                const diffX = endX - startX;
                const diffY = endY - startY;

                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    if (diffX > 0) {
                        goToPrevPage();
                    } else {
                        goToNextPage();
                    }
                }
            });

            // Клавиши клавиатуры
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') goToPrevPage();
                if (e.key === 'ArrowRight') goToNextPage();
                if (e.key === 'Escape') passwordInput.focus();
            });
        }

        function showPage(index) {
            if (index < 0 || index >= CONFIG.TOTAL_PAGES) return;



            // Скрываем текущую страницу
            pages[currentPage].classList.remove('active');
            if (index < currentPage) {
                pages[currentPage].classList.add('prev');
            }
            pages[currentPage].classList.remove('prev');

            // Показываем новую страницу
            currentPage = index;
            pages[currentPage].classList.add('active');

            updateNavigation();
            updatePageIndicator();

            // Инициализация конкретной страницы
            switch(currentPage) {
                case 0: initCardPage(); break;
                case 1: initBoltPage(); break;
                case 2: initScratchPage(); break;
                case 3: initShakePage(); break;
                case 4: initPuzzlePage(); break;
                case 5: initGalleryPage(); break;
                case 6: initHeartExplosionPage(); break;
                case 7: initFinalPage(); break;
            }
        }

        function goToPrevPage() {
            if (currentPage > 0) {
                showPage(currentPage - 1);
            }
        }

        function goToNextPage() {
            // Проверяем, выполнено ли задание на текущей странице
            

            if (currentPage < CONFIG.TOTAL_PAGES - 1) {
                showPage(currentPage + 1);
            }
        }

        function updateNavigation() {
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage === CONFIG.TOTAL_PAGES - 1;
        }

        function updatePageIndicator() {
            indicatorDots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentPage);
            });
        }

        // СТРАНИЦА 1: ОТКРЫТКА - ИСПРАВЛЕНО
        function initCardPage() {
            const card = document.getElementById('card');
            card.classList.remove('open');

            const openCard = () => {
                card.classList.add('open');
                playSound('open');
                pageCompleted[0] = true;

            };

            card.addEventListener('click', openCard);

            // Свайп для открытия
            let cardStartX = 0;
            card.addEventListener('touchstart', (e) => {
                cardStartX = e.touches[0].clientX;
            });

            card.addEventListener('touchend', (e) => {
                const endX = e.changedTouches[0].clientX;
                if (endX - cardStartX < -50) {
                    openCard();
                }
            });


        }

        // СТРАНИЦА 2: БОЛТ
        function initBoltPage() {
            const bolt = document.getElementById('bolt');
            const shield = document.getElementById('shield');
            const message = document.getElementById('message-under-shield');
            let rotation = 0;
            let isDragging = false;
            let startAngle = 0;

            const startDrag = (e) => {
                isDragging = true;
                const rect = bolt.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                startAngle = Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;

                const moveHandler = (e) => drag(e);
                const endHandler = () => stopDrag();

                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('touchmove', moveHandler);
                document.addEventListener('mouseup', endHandler);
                document.addEventListener('touchend', endHandler);
            };

            const drag = (e) => {
                if (!isDragging) return;

                const rect = bolt.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                const angle = Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;

                let delta = angle - startAngle;
                if (delta > 180) delta -= 360;
                if (delta < -180) delta += 360;

                // Только против часовой стрелки
                if (delta < 0) {
                    rotation += delta;
                    bolt.style.transform = `rotate(${rotation}deg)`;

                    if (rotation < -360) {
                        boltComplete();
                    }
                }

                startAngle = angle;
            };

            const stopDrag = () => {
                isDragging = false;
                const moveHandler = (e) => drag(e);
                const endHandler = () => stopDrag();

                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('mouseup', endHandler);
                document.removeEventListener('touchend', endHandler);
            };

            const boltComplete = () => {
                isDragging = false;
                bolt.style.transition = 'transform 0.5s';
                bolt.style.transform = 'rotate(-720deg) scale(0.8)';

                setTimeout(() => {
                    message.classList.add('show');
                    playSound('success');
                    pageCompleted[1] = true;


                    setTimeout(() => {
                        shield.classList.add('fall-off');
                        createConfetti();
                    }, 1000);
                }, 500);
            };

            bolt.addEventListener('mousedown', startDrag);
            bolt.addEventListener('touchstart', startDrag);


        }

        // СТРАНИЦА 3: СТИРАНИЕ
        function initScratchPage() {
            if (pageCompleted[2]) { return }

            const canvas = document.getElementById('scratch-canvas');
            const ctx = canvas.getContext('2d');
            const container = document.querySelector('.scratch-container');
            const overlay = document.getElementById('scratch-overlay');
            const percentText = document.getElementById('scratch-percent');
            const image = document.getElementById('scratch-message');

            // Устанавливаем размеры канваса
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            // Заполняем канвас черным цветом
            ctx.fillStyle = 'rgba(0, 0, 0, 1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'destination-out';

            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            const startDrawing = (e) => {
                isDrawing = true;
                const pos = getPosition(e);
                [lastX, lastY] = [pos.x, pos.y];
                draw(e);
            };

            const draw = (e) => {
                if (!isDrawing) return;

                e.preventDefault();
                const pos = getPosition(e);

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.lineWidth = 40;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();

                [lastX, lastY] = [pos.x, pos.y];

                updateScratchPercent();
            };

            const stopDrawing = () => {
                isDrawing = false;
            };

            const getPosition = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            };

            const updateScratchPercent = () => {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;
                let transparentPixels = 0;

                for (let i = 3; i < pixels.length; i += 4) {
                    if (pixels[i] === 0) transparentPixels++;
                }

                scratchPercent = Math.round((transparentPixels / (pixels.length / 4)) * 100);
                percentText.textContent = `Стерто: ${scratchPercent}%`;

                // Уменьшаем непрозрачность оверлея
                overlay.style.opacity = (100 - scratchPercent) / 100;

                // Уменьшаем размытие изображения
                const blurAmount = 15 - (scratchPercent / 100) * 15;
                image.style.filter = `blur(${blurAmount}px)`;

                if (scratchPercent >= CONFIG.SCRATCH_THRESHOLD && !pageCompleted[2]) {
                    finishScratching();
                }
            };

            const finishScratching = () => {
                pageCompleted[2] = true;
                canvas.style.opacity = '0';
                overlay.style.opacity = '0';
                image.style.filter = 'blur(0)';
                let ele = document.querySelector('.scratch-text')
                ele.textContent = '';

                playSound('success');
                createConfetti();


                // Стираем весь холст для показа изображения
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                scratchPercent = 100;
                percentText.textContent = `Стерто: 100%`;
            };

            // Назначаем события
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);

            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);


        }

        // СТРАНИЦА 4: ВСТРЯХНУТЬ - ИСПРАВЛЕНО
        // ==== РЕПЛЕЙС: initShakePage ====
// Страница 4: Стряхни тайну – исправленная версия
function initShakePage() {
    // Находим элементы

    if (pageCompleted[3]) {

        return; // завершаем инициализацию, обработчики не навешиваем
    }

    const button = document.getElementById('shake-button');
    const image = document.getElementById('shake-message');
    const overlay = document.getElementById('shake-overlay');


    if (!button || !image || !overlay) {

        return;
    }

    // Если страница уже была пройдена – сразу показываем открытый результат
    if (pageCompleted[3]) {

        image.style.filter = 'blur(0)';
        overlay.style.clipPath = 'inset(0%)';
        overlay.style.opacity = '0';
        button.disabled = true;
        button.textContent = 'Готово!';
        return; // завершаем инициализацию, обработчики не навешиваем
    }

    // Убираем инлайн-обработчик, если он есть
    button.removeAttribute('onclick');

    // Состояние страницы (храним глобально для совместимости с другими частями)
    window._shakeState = window._shakeState || {
        actions: 0,
        required: CONFIG.SHAKE_ACTIONS_REQUIRED || 5,
        lastShakeTime: 0,
        history: []
    };
    const state = window._shakeState;

    // Сбрасываем прогресс при каждом открытии страницы (если нужно)
    state.actions = 0;
    state.history = [];

    // Начальные стили
    image.style.transition = 'filter 0.3s ease';
    image.style.filter = 'blur(20px)';

    overlay.style.transition = 'clip-path 0.3s ease, opacity 0.3s ease';
    overlay.style.clipPath = 'inset(50% 50% 50% 50%)'; // полностью закрыто
    overlay.style.opacity = '1';
    overlay.style.pointerEvents = 'none';

    // Функция обновления UI
    function updateUI() {
        const progress = state.actions / state.required;
        const blurAmount = 20 * (1 - progress);
        image.style.filter = `blur(${blurAmount}px)`;

        const insetPercent = 50 * (1 - progress);
        overlay.style.clipPath = `inset(${insetPercent}% ${insetPercent}% ${insetPercent}% ${insetPercent}%)`;
        overlay.style.opacity = 1 - progress * 0.8; // плавно исчезает

        button.textContent = `Стряхнуть размытие (${state.actions}/${state.required})`;
    }

    // Функция, выполняемая при одном действии (нажатие или тряска)
    function applyAction() {

        if (state.actions >= state.required) return;

        state.actions++;
        updateUI();

        // Визуальная обратная связь
        image.style.transform = 'scale(1.02)';
        setTimeout(() => image.style.transform = 'scale(1)', 150);

        // Вибрация (если поддерживается)
        if (navigator.vibrate) navigator.vibrate(50);

        // Если достигнут лимит – завершаем
        if (state.actions >= state.required) {
            overlay.style.transition = 'opacity 0.5s';
            overlay.style.opacity = '0';
            image.style.filter = 'blur(0)';
            button.disabled = true;
            button.textContent = 'Готово!';
            pageCompleted[3] = true;
            //pageCompleted[4] = true;

            createConfetti(); // добавим конфетти для радости
        }
    }

    // Обработчик клика по кнопке
    button.addEventListener('click', applyAction);

    // ----- Обработка тряски (devicemotion) -----
    async function setupMotionListener() {
        // Запрос разрешения для iOS
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            try {
                const response = await DeviceMotionEvent.requestPermission();
                if (response !== 'granted') {

                    return;
                }
            } catch (err) {

                return;
            }
        }

        // Проверка поддержки devicemotion
        if (!window.DeviceMotionEvent) {

            return;
        }

        let lastShake = 0;
        const SHAKE_THRESHOLD = 5; // можно подобрать опытным путём
        const MIN_TIME_BETWEEN_SHAKES = 500; // мс

        function motionHandler(event) {
            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            const now = Date.now();
            if (now - lastShake < MIN_TIME_BETWEEN_SHAKES) return;

            const magnitude = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
            // Сохраняем последние несколько значений для сглаживания
            state.history.push(magnitude);
            if (state.history.length > 5) state.history.shift();

            const avg = state.history.reduce((a, b) => a + b, 0) / state.history.length;
            if (avg > SHAKE_THRESHOLD) {
                lastShake = now;
                applyAction();
            }
        }

        window.addEventListener('devicemotion', motionHandler);

        // Очистка при уходе со страницы (если нужно)
        return () => window.removeEventListener('devicemotion', motionHandler);
    }

    // Запускаем настройку motionListener
    setupMotionListener().catch(e => LogSystem?.error('Motion setup error: ' + e));

    // Первоначальное обновление UI
    updateUI();


}




        // СТРАНИЦА 5: ПАЗЛ - ИСПРАВЛЕН (твой код)
        // СТРАНИЦА 5: ПАЗЛ – исправленная версия для мобильных
// СТРАНИЦА 5: ПАЗЛ – универсальная версия (десктоп drag-and-drop, мобильная click)
// СТРАНИЦА 5: ПАЗЛ – универсальная версия (десктоп drag-and-drop, мобильная click)
        // СТРАНИЦА 5: ПАЗЛ – универсальная версия (десктоп drag-and-drop, мобильная click)
        function initPuzzlePage() {
    // ЕСЛИ ПАЗЛ УЖЕ СОБРАН – ПОКАЗЫВАЕМ ЗАВЕРШЁННОЕ СОСТОЯНИЕ И ВЫХОДИМ
    if (pageCompleted[4]) {
        displaySolvedPuzzle();
        return;
    }

    const isMobile = window.innerWidth <= 768; // мобильные устройства
    if (isMobile) {
        initPuzzleMobile();
    } else {
        initPuzzleDesktop();
    }

    // ---------- Функция отображения собранного пазла (без перемешивания) ----------
    function displaySolvedPuzzle() {
        const puzzle = document.getElementById('puzzle');
        puzzle.innerHTML = ''; // очищаем

        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = 'https://images.unsplash.com/photo-1770370358383-e5a0a70b8cc7?q=80&w=688&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D';

        img.onload = () => {
            // Создаём холст 300x300 с изображением, сохраняя пропорции (cover)
            const canvas = document.createElement('canvas');
            canvas.width = 300;
            canvas.height = 300;
            const ctx = canvas.getContext('2d');

            const imgW = img.naturalWidth;
            const imgH = img.naturalHeight;
            const scale = Math.max(300 / imgW, 300 / imgH);
            const drawW = imgW * scale;
            const drawH = imgH * scale;
            const offsetX = (300 - drawW) / 2;
            const offsetY = (300 - drawH) / 2;
            ctx.drawImage(img, 0, 0, imgW, imgH, offsetX, offsetY, drawW, drawH);

            // Разрезаем холст на 9 кусочков 100x100
            const size = 3;
            const pieceW = 100;
            const pieceH = 100;
            const pieces = [];

            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const px = c * pieceW;
                    const py = r * pieceH;
                    const data = ctx.getImageData(px, py, pieceW, pieceH);

                    const pCanvas = document.createElement('canvas');
                    pCanvas.width = pieceW;
                    pCanvas.height = pieceH;
                    pCanvas.getContext('2d').putImageData(data, 0, 0);

                    const url = pCanvas.toDataURL();
                    pieces.push({
                        id: r * size + c,
                        url
                    });
                }
            }

            // СОРТИРУЕМ ПО ID (чтобы получить правильный порядок)
            pieces.sort((a, b) => a.id - b.id);

            // Создаём элементы, но без обработчиков и без draggable
            pieces.forEach((p) => {
                const el = document.createElement('div');
                el.className = 'puzzle-piece';
                el.style.backgroundImage = `url(${p.url})`;
                el.dataset.id = p.id;
                // Можно добавить класс для неактивного состояния
                el.classList.add('solved-piece');
                // Убираем возможность перетаскивания и кликов
                el.draggable = false;
                el.style.pointerEvents = 'none';
                puzzle.appendChild(el);
            });
        };

        img.onerror = () => {

            for (let i = 0; i < 9; i++) {
                const el = document.createElement('div');
                el.className = 'puzzle-piece';
                el.style.background = 'linear-gradient(135deg, #ff99cc, #ff66a3)';
                el.dataset.id = i;
                el.draggable = false;
                el.style.pointerEvents = 'none';
                puzzle.appendChild(el);
            }
        };
    }

    // ---------- Десктопная версия (drag-and-drop) ----------
    function initPuzzleDesktop() {
        const puzzle = document.getElementById('puzzle');
        puzzle.innerHTML = '';

        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = 'https://images.unsplash.com/photo-1770370358383-e5a0a70b8cc7?q=80&w=688&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D';

        img.onload = () => {

            const canvas = document.createElement('canvas');
            canvas.width = 300;
            canvas.height = 300;
            const ctx = canvas.getContext('2d');

            const imgW = img.naturalWidth;
            const imgH = img.naturalHeight;
            const scale = Math.max(300 / imgW, 300 / imgH);
            const drawW = imgW * scale;
            const drawH = imgH * scale;
            const offsetX = (300 - drawW) / 2;
            const offsetY = (300 - drawH) / 2;
            ctx.drawImage(img, 0, 0, imgW, imgH, offsetX, offsetY, drawW, drawH);

            let pieces = [];
            const size = 3;
            const pieceW = 100;
            const pieceH = 100;

            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const px = c * pieceW;
                    const py = r * pieceH;
                    const data = ctx.getImageData(px, py, pieceW, pieceH);

                    const pCanvas = document.createElement('canvas');
                    pCanvas.width = pieceW;
                    pCanvas.height = pieceH;
                    pCanvas.getContext('2d').putImageData(data, 0, 0);

                    const url = pCanvas.toDataURL();
                    pieces.push({
                        id: r * size + c,
                        url
                    });
                }
            }

            pieces = pieces.sort(() => Math.random() - 0.5);

            pieces.forEach((p, idx) => {
                const el = document.createElement('div');
                el.className = 'puzzle-piece';
                el.draggable = true;
                el.style.backgroundImage = `url(${p.url})`;
                el.dataset.id = p.id;
                el.dataset.pos = idx;

                el.addEventListener('dragstart', (e) => {
                    e.dataTransfer.setData('text/plain', e.target.dataset.id);
                });

                el.addEventListener('dragover', (e) => {
                    e.preventDefault();
                });

                el.addEventListener('drop', (e) => {
                    e.preventDefault();
                    const sourceId = e.dataTransfer.getData('text/plain');
                    const targetId = e.target.dataset.id;

                    const sourceEl = Array.from(puzzle.children).find(x => x.dataset.id === sourceId);
                    const targetEl = e.target;

                    const tmpBg = sourceEl.style.backgroundImage;
                    const tmpId = sourceEl.dataset.id;

                    sourceEl.style.backgroundImage = targetEl.style.backgroundImage;
                    sourceEl.dataset.id = targetEl.dataset.id;

                    targetEl.style.backgroundImage = tmpBg;
                    targetEl.dataset.id = tmpId;

                    checkPuzzleSolved();
                });

                puzzle.appendChild(el);
            });
        };

        img.onerror = () => {

            for (let i = 0; i < 9; i++) {
                const el = document.createElement('div');
                el.className = 'puzzle-piece';
                el.style.background = 'linear-gradient(135deg, #ff99cc, #ff66a3)';
                el.draggable = true;
                puzzle.appendChild(el);
            }
        };

        function checkPuzzleSolved() {
            const pieces = Array.from(puzzle.children);
            let ok = true;
            pieces.forEach((el, idx) => {
                if (!el.dataset.id || Number(el.dataset.id) !== idx) {
                    ok = false;
                }
            });

            if (ok && !pageCompleted[4]) {
                pageCompleted[4] = true;
                createConfetti();
                playSound('success');

                setTimeout(() => {
                    alert('Сердечко собрано ❤️\nТы чудо!');
                }, 200);
            }
        }


    }

    // ---------- Мобильная версия (клики, без миниатюры) ----------
    function initPuzzleMobile() {
        const puzzle = document.getElementById('puzzle');
        puzzle.innerHTML = '';

        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.src = 'https://images.unsplash.com/photo-1770370358383-e5a0a70b8cc7?q=80&w=688&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D';

        img.onload = () => {


            const canvas = document.createElement('canvas');
            canvas.width = 300;
            canvas.height = 300;
            const ctx = canvas.getContext('2d');

            const imgW = img.naturalWidth;
            const imgH = img.naturalHeight;
            const scale = Math.max(300 / imgW, 300 / imgH);
            const drawW = imgW * scale;
            const drawH = imgH * scale;
            const offsetX = (300 - drawW) / 2;
            const offsetY = (300 - drawH) / 2;
            ctx.drawImage(img, 0, 0, imgW, imgH, offsetX, offsetY, drawW, drawH);

            let pieces = [];
            const size = 3;
            const pieceW = 100;
            const pieceH = 100;

            for (let r = 0; r < size; r++) {
                for (let c = 0; c < size; c++) {
                    const px = c * pieceW;
                    const py = r * pieceH;
                    const data = ctx.getImageData(px, py, pieceW, pieceH);

                    const pCanvas = document.createElement('canvas');
                    pCanvas.width = pieceW;
                    pCanvas.height = pieceH;
                    pCanvas.getContext('2d').putImageData(data, 0, 0);

                    const url = pCanvas.toDataURL();
                    pieces.push({
                        id: r * size + c,
                        url
                    });
                }
            }

            pieces = pieces.sort(() => Math.random() - 0.5);

            let selectedPiece = null;

            pieces.forEach((p, idx) => {
                const el = document.createElement('div');
                el.className = 'puzzle-piece';
                el.style.backgroundImage = `url(${p.url})`;
                el.dataset.id = p.id;
                el.dataset.pos = idx;

                el.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const currentEl = e.currentTarget;

                    if (!selectedPiece) {
                        selectedPiece = currentEl;
                        selectedPiece.style.border = '3px solid gold';
                        return;
                    }

                    if (selectedPiece === currentEl) {
                        selectedPiece.style.border = '';
                        selectedPiece = null;
                        return;
                    }

                    const tmpBg = selectedPiece.style.backgroundImage;
                    const tmpId = selectedPiece.dataset.id;

                    selectedPiece.style.backgroundImage = currentEl.style.backgroundImage;
                    selectedPiece.dataset.id = currentEl.dataset.id;

                    currentEl.style.backgroundImage = tmpBg;
                    currentEl.dataset.id = tmpId;

                    selectedPiece.style.border = '';
                    selectedPiece = null;

                    checkPuzzleSolved();
                });

                puzzle.appendChild(el);
            });
        };

        img.onerror = () => {

            for (let i = 0; i < 9; i++) {
                const el = document.createElement('div');
                el.className = 'puzzle-piece';
                el.style.background = 'linear-gradient(135deg, #ff99cc, #ff66a3)';
                el.dataset.id = i;
                puzzle.appendChild(el);
            }
        };

        function checkPuzzleSolved() {
            const pieces = Array.from(puzzle.children);
            let ok = true;
            pieces.forEach((el, idx) => {
                if (!el.dataset.id || Number(el.dataset.id) !== idx) {
                    ok = false;
                }
            });

            if (ok && !pageCompleted[4]) {
                pageCompleted[4] = true;
                createConfetti();
                playSound('success');

                setTimeout(() => {
                    alert('Сердечко собрано ❤️\nТы чудо!');
                }, 200);
            }
        }


    }
}


        //initPuzzlePage();

        // СТРАНИЦА 6: ГАЛЕРЕЯ - УБРАН АВТОСКРОЛЛ
        function initGalleryPage() {
            const slides = document.querySelectorAll('.gallery-slide');
            const nav = document.getElementById('gallery-nav');
            let currentSlide = 0;

            // Очищаем навигацию
            nav.innerHTML = '';

            // Создаем точки навигации
            slides.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = `gallery-dot ${index === 0 ? 'active' : ''}`;
                dot.dataset.index = index;
                dot.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showSlide(parseInt(e.target.dataset.index));
                });
                nav.appendChild(dot);
            });

            function showSlide(index) {
                slides[currentSlide].classList.remove('active');
                nav.children[currentSlide].classList.remove('active');

                currentSlide = index;

                slides[currentSlide].classList.add('active');
                nav.children[currentSlide].classList.add('active');
            }

            // Обработчики свайпов только для галереи
            const gallery = document.getElementById('gallery-container');
            let galleryStartX = 0;

            gallery.addEventListener('touchstart', (e) => {
                galleryStartX = e.touches[0].clientX;
                e.stopPropagation();
            });

            gallery.addEventListener('touchend', (e) => {
                const endX = e.changedTouches[0].clientX;
                const diff = galleryStartX - endX;

                if (Math.abs(diff) > 50) {
                    if (diff > 0 && currentSlide < slides.length - 1) {
                        showSlide(currentSlide + 1);
                    } else if (diff < 0 && currentSlide > 0) {
                        showSlide(currentSlide - 1);
                    }
                }

                e.stopPropagation();
            });


        }

        // СТРАНИЦА 7: СЕРДЕЧНЫЙ ВЗРЫВ - ИСПРАВЛЕН
        function initHeartExplosionPage() {
            const mainHeart = document.getElementById('main-heart');
            const container = document.getElementById('hearts-container') || document.body;
            const tapCounter = document.getElementById('tap-counter');

            // сохраняем состояние на window, чтобы при перелистывании можно было читать/менять
            window.__heartPageState = window.__heartPageState || { pageActive: false, exploded: false };
            window.__heartPageState.pageActive = true;
            // если глобально уже помечено как выполненная — приводим в соответствие
            window.__heartPageState.exploded = Boolean(window.__heartPageState.exploded || (pageCompleted && !pageCompleted[6]));

            // -------------------- UI helpers --------------------
            function updateTapCounter() {
                if (!tapCounter) return;
                const remaining = Math.max(0, (CONFIG && CONFIG.HEART_TAPS_REQUIRED ? CONFIG.HEART_TAPS_REQUIRED : 10) - (heartTaps || 0));
                tapCounter.textContent = `Нажми на сердце! Осталось: ${remaining}`;

                const intensity = (heartTaps || 0) / (CONFIG && CONFIG.HEART_TAPS_REQUIRED ? CONFIG.HEART_TAPS_REQUIRED : 10);
                const red = Math.floor(255 * intensity);
                const color = `rgb(${red}, ${Math.floor(100 - 90 * intensity)}, ${Math.floor(150 - 100 * intensity)})`;
                if (mainHeart) mainHeart.style.background = color;
            }

            function createHeartParticle() {
                if (!mainHeart || !container) return;
                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.width = '18px';
                particle.style.height = '18px';
                const bg = mainHeart.style.background || getComputedStyle(mainHeart).backgroundColor || 'var(--primary)';
                particle.style.background = bg;
                particle.style.borderRadius = '50%';
                particle.style.top = '50%';
                particle.style.left = '50%';
                particle.style.transform = 'translate(-50%, -50%)';
                particle.style.pointerEvents = 'none';
                container.appendChild(particle);

                const angle = Math.random() * Math.PI * 2;
                const distance = 40 + Math.random() * 120;
                const duration = 400 + Math.random() * 600;

                const toX = Math.cos(angle) * distance;
                const toY = Math.sin(angle) * distance;

                particle.animate([
                    { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 },
                    { transform: `translate(calc(-50% + ${toX}px), calc(-50% + ${toY}px)) scale(0)`, opacity: 0 }
                ], {
                    duration: duration,
                    easing: 'cubic-bezier(0.2, 0, 0.8, 1)',
                    fill: 'forwards'
                });

                setTimeout(() => particle.remove(), duration);
            }

            // -------------------- Безье-самплинг --------------------
            function cubicBezierPoint(t, p0, p1, p2, p3) {
                const u = 1 - t;
                const tt = t * t;
                const uu = u * u;
                const uuu = uu * u;
                const ttt = tt * t;
                const x = uuu * p0.x + 3 * uu * t * p1.x + 3 * u * tt * p2.x + ttt * p3.x;
                const y = uuu * p0.y + 3 * uu * t * p1.y + 3 * u * tt * p2.y + ttt * p3.y;
                return { x, y };
            }

            // -------------------- Улучшённый взрыв --------------------
            function createHeartExplosion(opts = {}) {
                if (!mainHeart || !container) return;

                const {
                    count = 57,
                    durationMin = 3000,
                    durationMax = 7000,
                    maxDistance = 1160,
                    curveOffset = 9800,
                    steps = 500 // число ключевых кадров для каждой кривой (чем больше — тем плавнее)
                } = opts;

                // помечаем как выполненное и запрещаем дальнейшие клики
                window.__heartPageState.exploded = true;
                if (pageCompleted) pageCompleted[6] = true;
                mainHeart.style.pointerEvents = 'none';

                const rect = mainHeart.getBoundingClientRect();
                const startX = rect.left + rect.width / 2;
                const startY = rect.top + rect.height / 2;
                const emojis = ['❤️','💖','💕','💗','💓','💞','💘','✨','🌟','🎉'];

                for (let i = 0; i < count; i++) {
                    const el = document.createElement('div');
                    el.className = 'expl-emoji';
                    el.style.position = 'fixed';
                    el.style.left = `${startX}px`;
                    el.style.top = `${startY}px`;
                    el.style.transform = 'translate(-50%,-50%)';
                    el.style.pointerEvents = 'none';
                    el.style.fontSize = `${14 + Math.round(Math.random() * 22)}px`;
                    el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    container.appendChild(el);

                    const angle = Math.random() * Math.PI * 2;
                    const dist = (maxDistance * (0.4 + Math.random() * 0.6)); // от 40% до 100%
                    const endX = startX + Math.cos(angle) * dist;
                    const endY = startY + Math.sin(angle) * dist - (20 + Math.random() * 80); // чуть вверх

                    const cp1 = {
                        x: startX + Math.cos(angle - 0.6) * (dist * (0.2 + Math.random() * 0.2)) + (Math.random() - 0.5) * curveOffset,
                        y: startY + Math.sin(angle - 0.6) * (dist * (0.2 + Math.random() * 0.2)) + (Math.random() - 0.5) * curveOffset
                    };
                    const cp2 = {
                        x: startX + Math.cos(angle + 0.6) * (dist * (0.6 + Math.random() * 0.25)) + (Math.random() - 0.5) * curveOffset,
                        y: startY + Math.sin(angle + 0.6) * (dist * (0.6 + Math.random() * 0.25)) + (Math.random() - 0.5) * curveOffset
                    };

                    const duration = Math.round(durationMin + Math.random() * (durationMax - durationMin));

                    // собираем ключевые кадры, сэмплируя кривую в 'steps' точках
                    const frames = [];
                    for (let s = 0; s <= steps; s++) {
                        const t = s / steps;
                        const p = cubicBezierPoint(t,
                            { x: startX, y: startY },
                            cp1, cp2,
                            { x: endX, y: endY }
                        );
                        const relX = p.x - startX;
                        const relY = p.y - startY;
                        const scale = 1 - 0.6 * t;
                        const rot = Math.round(720 * t * (Math.random() > 0.5 ? 1 : -1));
                        frames.push({
                            transform: `translate(${relX}px, ${relY}px) translate(-50%,-50%) scale(${scale}) rotate(${rot}deg)`,
                            offset: t,
                            opacity: 1 - t
                        });
                    }

                    const anim = el.animate(frames, {
                        duration: duration,
                        easing: 'cubic-bezier(.2,.7,.2,1)',
                        fill: 'forwards'
                    });

                    anim.onfinish = () => { try { el.remove(); } catch (e) {} };
                }

                // плавное исчезновение основного сердца
                mainHeart.animate([
                    { transform: 'scale(1)', opacity: 1 },
                    { transform: 'scale(0.6)', opacity: 0 }
                ], { duration: 500, easing: 'ease-in', fill: 'forwards' });

                // дополнительные эффекты, если присутствуют
                if (typeof createConfetti === 'function') createConfetti();
                if (typeof playSound === 'function') playSound('explosion');
            }

            // -------------------- Взрывный вызов --------------------
            function explodeHeart() {
                // окончательно блокируем обработчик и запускаем эффект
                if (mainHeart) {
                    try { mainHeart.removeEventListener('pointerdown', tapHeart); } catch (e) {}
                }
                createHeartExplosion({
                    count: 57,
                    durationMin: 3000,
                    durationMax: 7000,
                    maxDistance: 716,
                    curveOffset: 350,
                    steps: 200
                });

            }

            // -------------------- Обработчик тапа --------------------
            let lastTapTime = 0;
            function tapHeart(e) {
                // блокируем если страница не активна или уже взорвано
                if (!window.__heartPageState || !window.__heartPageState.pageActive || window.__heartPageState.exploded) return;

                // допускаем только клики непосредственно по сердцу (или по его потомкам)
                if (!e.target || !e.target.closest || !e.target.closest('#main-heart')) return;

                e.preventDefault && e.preventDefault();
                const now = Date.now();
                if (now - lastTapTime < 40) return;
                lastTapTime = now;

                heartTaps = (typeof heartTaps === 'number') ? heartTaps + 1 : 1;
                updateTapCounter();

                // визуальный отклик
                if (mainHeart) {
                    mainHeart.style.animation = 'none';
                    setTimeout(() => { mainHeart.style.animation = 'pulse 0.5s'; }, 10);
                }
                createHeartParticle();
                if (typeof playSound === 'function') playSound('tap');

                const required = (CONFIG && CONFIG.HEART_TAPS_REQUIRED) ? CONFIG.HEART_TAPS_REQUIRED : 10;
                if (heartTaps >= required && !window.__heartPageState.exploded) {
                    explodeHeart();
                    // пометим, чтобы при последующих вызовах не допустить кликов по пустому месту
                    window.__heartPageState.exploded = true;
                    if (pageCompleted) pageCompleted[6] = true;
                }
            }

            // -------------------- Инициализация / навешивание --------------------
            // Если уже взорвано — сделаем сердечко недоступным и выйдем
            if (window.__heartPageState.exploded) {
                if (mainHeart) {
                    mainHeart.style.pointerEvents = 'none';
                    mainHeart.style.opacity = '0';
                }
                // всё: инициализация завершена — при возврате можно показать уже "взорванное" состояние
                return;
            }

            // сброс счётчика и обновление UI
            heartTaps = 0;
            updateTapCounter();

            // навешиваем pointerdown один раз
            mainHeart && mainHeart.addEventListener('pointerdown', tapHeart);

            // сохраняем функцию очистки (вызывать при уходе со страницы)
            window.__heartPageCleanup = function() {
                window.__heartPageState.pageActive = false;
                try { mainHeart && mainHeart.removeEventListener('pointerdown', tapHeart); } catch (e) {}
                // удаляем незавершённые эмодзи
                document.querySelectorAll('.expl-emoji').forEach(el => el.remove());
            };


        }

// Деинициализация/вызвать при перелистывании со страницы
        function destroyHeartExplosionPage() {
            window.__heartPageState = window.__heartPageState || { pageActive: false, exploded: false };
            window.__heartPageState.pageActive = false;
            // оставляем exploded как есть (если уже был взрыв — сохраняем)
            try { if (typeof window.__heartPageCleanup === 'function') { window.__heartPageCleanup(); window.__heartPageCleanup = null; } } catch (e) {}
            // удалить визуальные остатки
            document.querySelectorAll('.expl-emoji').forEach(el => el.remove());
        }

        // СТРАНИЦА 8: ФИНАЛ
        function initFinalPage() {
            const downloadBtn = document.getElementById('downloadBtn');

            downloadBtn.addEventListener('click', generateCardImage);

            // Создаем конфетти
            createConfetti();


        }

        // ГЕНЕРАЦИЯ И СКАЧИВАНИЕ ОТКРЫТКИ
        function generateCardImage() {
    const c = document.createElement('canvas');
    c.width = 800;
    c.height = 1000;
    const ctx = c.getContext('2d');

    // ----- Вспомогательные функции -----
    function drawHeart(ctx, x, y, size, opts = {}) {
        const s = size / 25;
        ctx.save();
        ctx.translate(x, y);
        if (opts.fill) ctx.beginPath();
        ctx.moveTo(0, -10 * s);
        ctx.bezierCurveTo(12 * s, -40 * s, 60 * s, -30 * s, 0, 30 * s);
        ctx.bezierCurveTo(-60 * s, -30 * s, -12 * s, -40 * s, 0, -10 * s);
        if (opts.fill) ctx.fill();
        else ctx.stroke();
        ctx.restore();
    }

    function wrapText(ctx, text, x, y, maxWidth, lineHeight, align = 'center') {
        const paragraphs = text.split('\n');
        let currentY = y;
        ctx.textAlign = align;
        for (let rawParagraph of paragraphs) {
            let paragraph = rawParagraph.trim();
            if (paragraph === '') {
                currentY += lineHeight; // пустая строка
                continue;
            }
            const words = paragraph.split(' ').filter(w => w.length > 0);
            if (words.length === 0) {
                currentY += lineHeight;
                continue;
            }
            let line = '';
            const lines = [];
            for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = ctx.measureText(testLine);
                if (metrics.width > maxWidth && n > 0) {
                    lines.push(line.trim());
                    line = words[n] + ' ';
                } else {
                    line = testLine;
                }
            }
            if (line) lines.push(line.trim());
            for (let i = 0; i < lines.length; i++) {
                ctx.fillText(lines[i], x, currentY + i * lineHeight);
            }
            currentY += lines.length * lineHeight;
        }
    }

    function drawPetalCluster(x, y, scale = 1, opacity = 0.34) {
        ctx.save();
        ctx.translate(x, y);
        ctx.globalAlpha = opacity;
        const petals = 5;
        for (let i = 0; i < petals; i++) {
            ctx.save();
            const angle = (i / petals) * Math.PI * 2;
            ctx.rotate(angle);
            ctx.beginPath();
            ctx.ellipse(8 * scale, 0, 9 * scale, 4.2 * scale, 0.6, 0, Math.PI * 2);
            ctx.fillStyle = '#e8b2c1';
            ctx.fill();
            ctx.restore();
        }
        ctx.restore();
    }

    // ----- 1. Нежный градиент фона -----
    const grad = ctx.createLinearGradient(0, 0, 0, c.height);
    grad.addColorStop(0, '#fffafc');
    grad.addColorStop(0.66, '#fff2f7');
    grad.addColorStop(1, '#ffeef6');
    ctx.fillStyle = grad;
    ctx.fillRect(0, 0, c.width, c.height);

    // ----- 2. Очень лёгкая текстура бумаги (очень немного точек) -----
    ctx.save();
    ctx.globalAlpha = 0.035;
    ctx.fillStyle = '#d8b7c3';
    for (let i = 0; i < 28; i++) { // мало точек ради скорости
        const x = Math.random() * c.width;
        const y = Math.random() * c.height;
        const r = 0.9 + Math.random() * 1.0;
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fill();
    }
    ctx.restore();

    // ----- 3. Тонкая рамка -----
    ctx.save();
    ctx.strokeStyle = '#e9b7c2';
    ctx.lineWidth = 1;
    ctx.strokeRect(34, 34, c.width - 68, c.height - 68);
    ctx.restore();

    // ----- 4. Угловые сердца -----
    ctx.save();
    ctx.fillStyle = '#f06d8b';
    ctx.globalAlpha = 0.62;
    const corners = [
        [54, 54], [c.width - 54, 54],
        [54, c.height - 54], [c.width - 54, c.height - 54]
    ];
    corners.forEach(([x, y]) => drawHeart(ctx, x, y, 20, { fill: true }));
    ctx.globalAlpha = 1;
    ctx.restore();

    // ----- 5. Лепестковые группы (аккуратно, вместо "волосков") -----
    drawPetalCluster(120, 210, 1.05, 0.34);
    drawPetalCluster(c.width - 140, 310, 1.1, 0.34);
    drawPetalCluster(140, c.height - 230, 1.0, 0.34);
    drawPetalCluster(250, 420, 0.7, 0.28);
    drawPetalCluster(c.width - 260, 480, 0.7, 0.28);

    // ----- 6. Заголовок — меньше, сдержанно -----


    // ----- 7. Акцентная строка — очень большая (вы просили) -----
    ctx.font = 'bold 38px "Dancing Script", cursive'; // крупная акцентная строка
    ctx.fillStyle = '#5b2430';
    ctx.textAlign = 'center';
    ctx.fillText('Самому дорогому и пушистому кролику!', c.width / 2, 188);

    // ----- 8. Основное послание — текст увеличен, более «перечитываемый» -----
    ctx.font = '26px "Caveat", cursive'; // увеличенный основной текст
    ctx.fillStyle = '#56343a';
    const message = 'От сердца и почек — дарю тебе цветочек!\n ' +
                    'Да ни один, а целых 101 розу!\n ' +
                    'Просто потому что 101 в двоичном коде — это 5,\n ' +
                    'а 5 — это мой максимальный балл за день, когда ты рядом.\n\n' +
                    'С 14 февраля, мой самый любимый терапевт сердца ❤️';
    wrapText(ctx, message, c.width / 2, 240, 680, 36);

    // ----- 9. Большое сердце — простой и выразительный знак -----
    ctx.save();
    ctx.translate(c.width / 2, 560);
    ctx.scale(2.05, 2.05);
    ctx.beginPath();
    ctx.moveTo(0, 18);
    ctx.bezierCurveTo(-18, -24, -45, -16, 0, 26);
    ctx.bezierCurveTo(45, -16, 18, -24, 0, 18);
    ctx.strokeStyle = '#ff6f98';
    ctx.lineWidth = 2.6;
    ctx.stroke();

    // Внутренний символ — маленькое сердце
    ctx.fillStyle = '#d63b5c';
    ctx.font = 'bold 92px "Noto Serif JP", "KaiTi", serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('❤', 0, 2);
    ctx.restore();

    // ----- 10. Мини-акценты блёстков — экономно -----
    ctx.save();
    for (let i = 0; i < 3; i++) {
        const x = 180 + Math.random() * (c.width - 360);
        const y = 460 + Math.random() * 320;
        ctx.globalAlpha = 0.24 + Math.random() * 0.28;
        ctx.beginPath();
        ctx.arc(x, y, 2 + Math.random() * 3.5, 0, Math.PI * 2);
        ctx.fillStyle = 'rgba(255,210,140,0.95)';
        ctx.fill();
    }
    ctx.restore();

    // ----- 11. Ленточка-штамп (верхняя правая) — оставил, но аккуратно -----


    // ----- 12. Печать внизу — крупная, читаемая и заметная -----
    ctx.save();
    const stampX = c.width / 2;
    const stampY = c.height - 110;
    const stampR = 82; // крупный радиус штампа
    // фон круга
    ctx.beginPath();
    ctx.arc(stampX, stampY, stampR, 0, Math.PI * 2);
    ctx.fillStyle = 'rgba(220,150,165,0.08)';
    ctx.fill();
    // внешняя двойная рамка
    ctx.lineWidth = 2;
    ctx.strokeStyle = '#d05d6f';
    ctx.setLineDash([6, 6]);
    ctx.beginPath();
    ctx.arc(stampX, stampY, stampR, 0, Math.PI * 2);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.lineWidth = 1.2;
    ctx.strokeStyle = '#e8a1ad';
    ctx.beginPath();
    ctx.arc(stampX, stampY, stampR - 8, 0, Math.PI * 2);
    ctx.stroke();

    // Большой день — очень крупный и контрастный
    ctx.fillStyle = '#7a2a35';
    ctx.font = '700 54px "Inter", sans-serif';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    ctx.fillText('14', stampX, stampY - 12);

    // Меньше — месяц и год под числом
    ctx.font = '600 16px "Inter", sans-serif';
    ctx.fillText('02 · 2026', stampX, stampY + 36);

    // Маленькая надпись внизу штампа
    ctx.font = 'bold 12px "Inter", sans-serif';
    //ctx.fillText('с любовью', stampX, stampY + 60);
    ctx.restore();

    // ----- 13. Подпись (снизу, чуть выше печати) -----
    ctx.save();
    ctx.font = '25px "Dancing Script", cursive';
    ctx.fillStyle = '#6d2a33';
    ctx.textAlign = 'center';
    // подпись разместил по центру чуть выше печати
    ctx.fillText('Бодя 🙃', c.width / 2, c.height - 170);
    ctx.restore();

    // ----- Скачивание -----
    const link = document.createElement('a');
    link.download = 'valentine-card.png';
    link.href = c.toDataURL('image/png');
    link.click();
}

        function wrapText(ctx, text, x, y, maxWidth, lineHeight, align = 'center') {
    const paragraphs = text.split('\n');
    let currentY = y;
    ctx.textAlign = align;
    for (let rawParagraph of paragraphs) {
        let paragraph = rawParagraph.trim();
        if (paragraph === '') {
            currentY += lineHeight; // пустая строка
            continue;
        }
        const words = paragraph.split(' ').filter(w => w.length > 0);
        if (words.length === 0) {
            currentY += lineHeight;
            continue;
        }
        let line = '';
        const lines = [];
        for (let n = 0; n < words.length; n++) {
            const testLine = line + words[n] + ' ';
            const metrics = ctx.measureText(testLine);
            if (metrics.width > maxWidth && n > 0) {
                lines.push(line.trim());
                line = words[n] + ' ';
            } else {
                line = testLine;
            }
        }
        if (line) lines.push(line.trim());
        for (let i = 0; i < lines.length; i++) {
            ctx.fillText(lines[i], x, currentY + i * lineHeight);
        }
        currentY += lines.length * lineHeight;
    }
}

        function drawHeart(ctx, x, y, size) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.bezierCurveTo(x - size / 2, y - size, x - size * 1.2, y + size / 2, x, y + size);
            ctx.bezierCurveTo(x + size * 1.2, y + size / 2, x + size / 2, y - size, x, y);
            ctx.fill();
        }

        // КОНФЕТТИ
        function createConfetti() {
            const confettiContainer = document.getElementById('confetti');
            const colors = ['#ff3366', '#ff6699', '#ff9966', '#ffcc00', '#66ccff', '#b399ff'];

            for (let i = 0; i < 100; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = `${Math.random() * 100}vw`;
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.width = `${Math.random() * 10 + 5}px`;
                piece.style.height = `${Math.random() * 10 + 5}px`;
                piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';

                confettiContainer.appendChild(piece);

                // Анимация падения
                const animation = piece.animate([
                    { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
                    { transform: `translateY(100vh) rotate(${Math.random() * 360}deg)`, opacity: 0 }
                ], {
                    duration: Math.random() * 3000 + 2000,
                    easing: 'cubic-bezier(0.2, 0, 0.8, 1)'
                });

                animation.onfinish = () => piece.remove();
            }
        }

        function createConfettiAtElement(element) {
            const rect = element.getBoundingClientRect();
            const confettiContainer = document.getElementById('confetti');
            const colors = ['#ff3366', '#ff6699', '#ff9966', '#ffcc00', '#66ccff', '#b399ff'];

            for (let i = 0; i < 50; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = `${rect.left + Math.random() * rect.width}px`;
                piece.style.top = `${rect.top + Math.random() * rect.height}px`;
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.width = `${Math.random() * 8 + 4}px`;
                piece.style.height = `${Math.random() * 8 + 4}px`;

                confettiContainer.appendChild(piece);

                // Анимация разлета
                const angle = Math.random() * Math.PI * 2;
                const distance = 100 + Math.random() * 200;

                piece.animate([
                    { transform: 'scale(1) rotate(0deg)', opacity: 1 },
                    { transform: `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px) scale(0) rotate(360deg)`, opacity: 0 }
                ], {
                    duration: Math.random() * 2000 + 1000,
                    easing: 'cubic-bezier(0.2, 0, 0.8, 1)'
                }).onfinish = () => piece.remove();
            }
        }

        // ЗВУКИ
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                if (type === 'success') {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);

                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                }
                else if (type === 'error') {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(196, audioContext.currentTime + 0.1);

                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                }
                else if (type === 'tap') {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);

                    gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                }
            } catch (e) {

            }
        }

        // ЗАПУСК
        document.addEventListener('DOMContentLoaded', init);

        // Решение проблемы с клавиатурой на мобильных
        document.addEventListener('touchstart', function() {
            if (document.activeElement === passwordInput) {
                setTimeout(() => {
                    passwordInput.focus();
                }, 100);
            }
        });
    </script>
</body>
</html>
