<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>❤️ Тайное послание для тебя</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&family=Marck+Script&family=Pacifico&family=Poiret+One&family=Playfair+Display:wght@400;700&family=Raleway:wght@300;400;600&family=Dancing+Script:wght@400;700&family=Great+Vibes&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        :root {
            --primary: #ff3366;
            --secondary: #ff66a3;
            --accent: #ff99cc;
            --light: #fff0f5;
            --dark: #2a0f1a;
            --gold: #ffd700;
            --silver: #c0c0c0;
            --purple: #b399ff;
            --blue: #66ccff;
        }

        body {
            background: linear-gradient(135deg, #0a0a2a 0%, #1a0a2a 50%, #2a0a1a 100%);
            color: white;
            font-family: 'Raleway', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        /* ЛОГИ */
        .log-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            width: 300px;
            max-height: 200px;
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid var(--primary);
            border-radius: 10px;
            padding: 10px;
            font-size: 10px;
            color: #00ff00;
            font-family: monospace;
            overflow-y: auto;
            z-index: 9999;
            display: none;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .log-error {
            color: #ff3366;
        }

        .log-success {
            color: #00ff88;
        }

        .log-warning {
            color: #ffcc00;
        }

        .log-info {
            color: #66ccff;
        }

        /* ЭКРАН ПАРОЛЯ */
        .screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 100;
        }

        #password-screen {
            background: radial-gradient(circle at center, rgba(255, 51, 102, 0.1) 0%, rgba(26, 10, 42, 0.95) 100%);
        }

        .password-container {
            background: rgba(255, 255, 255, 0.12);
            border-radius: 30px;
            padding: 40px 30px;
            max-width: 400px;
            width: 100%;
            border: 2px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 25px 70px rgba(255, 51, 102, 0.35),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .heart-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z'/%3E%3C/svg%3E") center/contain no-repeat;
            animation: heartbeat 1.2s ease-in-out infinite;
            filter: drop-shadow(0 5px 15px rgba(255, 51, 102, 0.6));
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.1); }
            50% { transform: scale(1.05); }
            75% { transform: scale(1.15); }
        }

        .password-input {
            width: 100%;
            padding: 18px 20px;
            font-size: 20px;
            background: rgba(255, 255, 255, 0.18);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 20px;
            color: white;
            text-align: center;
            margin: 25px 0;
            font-family: 'Dancing Script', cursive;
            transition: all 0.3s;
            letter-spacing: 2px;
            -webkit-appearance: none;
            appearance: none;
        }

        .password-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(255, 51, 102, 0.6);
            background: rgba(255, 255, 255, 0.25);
        }

        .submit-btn {
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 18px 40px;
            font-size: 22px;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Great Vibes', cursive;
            transition: all 0.3s;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 40px rgba(255, 51, 102, 0.5);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        /* ОСНОВНОЙ ЭКРАН */
        #main-screen {
            display: none;
        }

        .header {
            position: fixed;
            top: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 50;
            background: linear-gradient(to bottom, rgba(10, 10, 42, 0.95), transparent);
        }

        .logo {
            font-family: 'Great Vibes', cursive;
            font-size: 28px;
            color: var(--primary);
            text-shadow: 0 2px 10px rgba(255, 51, 102, 0.5);
        }

        .page-indicator {
            display: flex;
            gap: 8px;
        }

        .indicator-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transition: all 0.3s;
        }

        .indicator-dot.active {
            background: var(--primary);
            transform: scale(1.3);
            box-shadow: 0 0 10px var(--primary);
        }

        /* КАРУСЕЛЬ */
        .carousel {
            position: relative;
            width: 100%;
            height: 100vh;
            overflow: hidden;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 100px 20px 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transform: translateX(100%);
            opacity: 0;
            transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1),
                        opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page.active {
            transform: translateX(0);
            opacity: 1;
        }

        .page.prev {
            transform: translateX(-100%);
        }

        .page-content {
            width: 100%;
            max-width: 500px;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        /* СТРАНИЦА 1: ОТКРЫТКА - ИСПРАВЛЕНА */
        .card-container {
            perspective: 2000px;
            width: 100%;
            max-width: 320px;
            height: 450px;
            cursor: pointer;
            margin: 0 auto;
        }

        @media (max-width: 480px) {
            .card-container {
                max-width: 280px;
                height: 400px;
            }
        }

        .card {
            position: relative;
            width: 100%;
            height: 100%;
            transform-style: preserve-3d;
            transition: transform 1.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .card.open {
            transform: rotateY(-180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 30px 80px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 30px;
            text-align: center;
        }

        .card-front {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .card-back {
            background: white;
            color: var(--dark);
            transform: rotateY(180deg);
            overflow-y: auto;
        }

        .open-instruction {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            font-family: 'Caveat', cursive;
            font-size: 20px;
            color: rgba(255, 255, 255, 0.9);
            animation: float 3s ease-in-out infinite;
            white-space: nowrap;
        }

        @keyframes float {
            0%, 100% { transform: translateX(-50%) translateY(0); }
            50% { transform: translateX(-50%) translateY(-10px); }
        }

        /* СТРАНИЦА 2: БОЛТ */
        .shield-container {
            position: relative;
            width: 300px;
            height: 300px;
            margin: 20px auto;
            aspect-ratio: 1 / 1; /*Квадратная форма*/
        }

        @media (max-width: 480px) {
            .shield-container {
                width: 250px;
                height: 250px;
            }
        }

        .shield {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(45deg, var(--silver), #e0e0e0);
            border-radius: 50%;
            box-shadow:
                0 0 0 10px rgba(255, 255, 255, 0.1),
                inset 0 0 20px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 15px solid var(--gold);
            transition: transform 0.5s ease;
        }

        .bolt-hole {
            position: absolute;
            width: 100px;
            height: 100px;
            background: linear-gradient(45deg, #1a0a2a, #2a1a3a);
            border-radius: 50%;
            border: 5px solid var(--gold);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2;
        }

        .bolt {
            width: 70px;
            height: 70px;
            background: conic-gradient(var(--gold), #ffcc00, var(--gold));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            cursor: grab;
            touch-action: none;
            box-shadow:
                0 5px 15px rgba(0, 0, 0, 0.3),
                inset 0 2px 5px rgba(255, 255, 255, 0.5);
            position: relative;
            z-index: 3;
            transition: transform 0.1s;
        }

        .bolt-direction {
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 24px;
            color: var(--gold);
            animation: spin 2s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateX(-50%) rotate(0deg); }
            100% { transform: translateX(-50%) rotate(-360deg); }
        }

        .message-under-shield {
            position: absolute;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border-radius: 50%;
            opacity: 0;
            transform: scale(0.8);
            transition: all 0.5s ease;
            font-family: 'Dancing Script', cursive;
            font-size: 24px;
            color: white;
            text-align: center;
            padding: 20px;
            z-index: 1;
        }

        .message-under-shield.show {
            opacity: 1;
            transform: scale(1);
        }

        .shield.fall-off {
            transform: translateY(100vh) rotate(360deg);
            opacity: 0;
            transition: transform 1.5s ease, opacity 1.5s ease;
        }

        /* СТРАНИЦА 3: СТИРАНИЕ */
        .scratch-container {
            width: 320px;
            height: 320px;
            position: relative;
            margin: 20px auto;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        @media (max-width: 480px) {
            .scratch-container {
                width: 280px;
                height: 280px;
            }
        }

        .scratch-canvas {
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            cursor: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="32" height="32"><circle cx="16" cy="16" r="14" fill="white" opacity="0.8"/></svg>') 16 16, crosshair;
            touch-action: none;
            z-index: 2;
        }

        .scratch-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1;
            filter: blur(15px);
            transition: filter 0.5s;
        }

        .scratch-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 0;
            transition: opacity 1s;
        }

        .scratch-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Marck Script', cursive;
            font-size: 28px;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            pointer-events: none;
            text-align: center;
            z-index: 3;
        }

        .scratch-percent {
            margin-top: 15px;
            font-family: 'Caveat', cursive;
            font-size: 22px;
            color: var(--primary);
        }

        /* СТРАНИЦА 4: ВСТРЯХНУТЬ - ИСПРАВЛЕНА */
        .shake-container {
            width: 300px;
            height: 300px;
            position: relative;
            margin: 20px auto;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .shake-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            position: absolute;
            top: 0;
            left: 0;
            filter: blur(20px);
            transition: filter 0.3s;
        }

        /* Замените текущую clip-path у .shake-overlay на это */
        .shake-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(10px);
            transition: clip-path 0.35s ease, opacity 0.35s ease, transform 0.3s ease;
            /* начальный формат inset — согласованный с JS */
            /*clip-path: inset(50% 50% 50% 50%);*/
            pointer-events: none; /* чтобы оверлей не блокировал кнопки (если нужно) */
        }


        .shake-button {
            margin-top: 30px;
            padding: 15px 40px;
            background: linear-gradient(45deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 50px;
            color: white;
            font-family: 'Pacifico', cursive;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .shake-button:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 51, 102, 0.4);
        }

        /* СТРАНИЦА 5: ПАЗЛ - ИСПРАВЛЕН */
        .puzzle-area {
            width: 320px;
            height: 320px;
            border-radius: 12px;
            background: linear-gradient(180deg, #fff3f6, #fff);
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 6px;
            padding: 6px;
            margin: 20px auto;
        }


        @media (max-width: 480px) {
            .puzzle-area {
                width: 280px;
                height: 280px;
            }
        }

        .puzzle-piece {
            background-size: cover;
            border-radius: 8px;
            cursor: grab;
            transition: transform 0.2s;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .puzzle-piece:active {
            cursor: grabbing;
            transform: scale(1.05);
            z-index: 10;
        }

        /* СТРАНИЦА 6: ГАЛЕРЕЯ */
        .gallery-container {
            width: 100%;
            max-width: 400px;
            height: 400px;
            position: relative;
            margin: 20px auto;
            overflow: hidden;
            border-radius: 20px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.4);
        }

        @media (max-width: 480px) {
            .gallery-container {
                height: 350px;
            }
        }

        .gallery-slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transform: scale(0.9);
            transition: all 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-size: cover;
            background-position: center;
            border-radius: 20px;
        }

        .gallery-slide.active {
            opacity: 1;
            transform: scale(1);
        }

        .gallery-nav {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-top: 20px;
        }

        .gallery-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            cursor: pointer;
            transition: all 0.3s;
        }

        .gallery-dot.active {
            background: var(--primary);
            transform: scale(1.5);
            box-shadow: 0 0 15px var(--primary);
        }

        /* СТРАНИЦА 7: СЕРДЕЧНЫЙ ВЗРЫВ - ИСПРАВЛЕН */
        .hearts-container {
            width: 300px;
            height: 300px;
            position: relative;
            margin: 20px auto;
        }

        .main-heart {
            width: 120px;
            height: 120px;
            background: var(--primary);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            clip-path: polygon(50% 15%, 80% 0, 100% 35%, 50% 100%, 0 35%, 20% 0);
            cursor: pointer;
            transition: all 0.3s;
            animation: pulse 2s infinite;
            box-shadow: 0 10px 30px rgba(255, 51, 102, 0.4);
        }

        .main-heart:hover {
            transform: translate(-50%, -50%) scale(1.1);
        }

        .main-heart:active {
            transform: translate(-50%, -50%) scale(0.95);
        }

        .tap-counter {
            margin-top: 20px;
            font-family: 'Caveat', cursive;
            font-size: 24px;
            color: var(--primary);
        }

        /* СТРАНИЦА 8: ФИНАЛ */
        .final-message {
            max-width: 400px;
            margin: 0 auto;
        }

        .final-heart {
            font-size: 80px;
            margin: 20px 0;
            animation: heartbeat 1.2s infinite;
        }

        .download-btn {
            margin-top: 30px;
            padding: 15px 40px;
            background: linear-gradient(45deg, var(--primary), var(--purple));
            border: none;
            border-radius: 50px;
            color: white;
            font-family: 'Pacifico', cursive;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s;

        }

        .download-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(255, 51, 102, 0.4);
        }

        /* НАВИГАЦИЯ */
        .nav-buttons {
            position: fixed;
            bottom: 30px;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 20px;
            padding: 0 20px;
            z-index: 50;
        }

        .nav-btn {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.1);
        }

        .nav-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        /* КОНФЕТТИ */
        .confetti {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1000;
        }

        .confetti-piece {
            position: absolute;
            width: 10px;
            height: 10px;
            top: -10px;
            opacity: 0;
        }

        /* АНИМАЦИЯ ПАДЕНИЯ */
        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(360deg);
            }
        }

        /* АДАПТИВНОСТЬ */
        @media (max-width: 768px) {
            .card-container {
                width: 280px;
                height: 400px;
            }

            .shield-container,
            .scratch-container,
            .shake-container {
                width: 280px;
                height: 280px;
            }

            .page {
                padding: 90px 15px 120px;
            }

            .nav-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }
        }

        @media (max-width: 480px) {
            .password-container {
                padding: 30px 20px;
            }

            .password-input {
                font-size: 18px;
                padding: 15px;
            }

            .submit-btn {
                font-size: 20px;
                padding: 15px 30px;
            }

            .page {
                padding: 80px 15px 110px;
            }
        }


    </style>
</head>
<body>
    <!-- ПАНЕЛЬ ЛОГОВ -->
    <div class="log-panel" id="log-panel">
        <div class="log-entry log-info">Система запущена...</div>
    </div>

    <!-- ЭКРАН ПАРОЛЯ -->
    <div id="password-screen" class="screen">
        <div class="password-container">
            <div class="heart-icon"></div>
            <h1 style="font-family: 'Great Vibes', cursive; font-size: 36px; margin-bottom: 10px; color: var(--primary); text-shadow: 0 2px 10px rgba(255, 51, 102, 0.5);">
                Для моей любимой ❤️
            </h1>
            <p style="margin-bottom: 20px; color: rgba(255, 255, 255, 0.9); font-family: 'Caveat', cursive; font-size: 22px;">
                Открой тайное послание...
            </p>
            <input type="text" id="password-input" class="password-input" placeholder="Нажми сюда и введи код...">
            <button id="submit-btn" class="submit-btn">Открыть сердце</button>
            <p style="margin-top: 20px; font-size: 16px; color: rgba(255, 255, 255, 0.6);">
                Подсказка: то, что я говорю тебе каждое утро
            </p>
        </div>
    </div>

    <!-- ОСНОВНОЙ ЭКРАН -->
    <div id="main-screen" class="screen">
        <div class="header">
            <div class="logo">Для любимой ❤️</div>
            <div class="page-indicator" id="page-indicator">
                <div class="indicator-dot active"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
                <div class="indicator-dot"></div>
            </div>
        </div>

        <div class="carousel">
            <!-- СТРАНИЦА 1: ОТКРЫТКА -->
            <div class="page active" id="page1">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 30px; color: var(--primary);">
                        Открой меня...
                    </h2>
                    <div class="card-container">
                        <div class="card" id="card">
                            <div class="card-front">
                                <div style="font-family: 'Dancing Script', cursive; font-size: 28px; margin-bottom: 10px;">
                                    Для тебя, моя любовь
                                </div>
                                <div style="font-family: 'Caveat', cursive; font-size: 18px; opacity: 0.9;">
                                    Нажми, чтобы открыть послание...
                                </div>
                                <div class="open-instruction">Нажми на меня</div>
                            </div>
                            <div class="card-back">
                                <div style="font-family: 'Great Vibes', cursive; font-size: 30px; color: var(--primary); margin-bottom: 15px;">
                                    С 14 февраля!
                                </div>
                                <div style="font-family: 'Caveat', cursive; font-size: 20px; color: #666; line-height: 1.5; margin-bottom: 15px;">
                                    Дорогая моя, с каждым днём я люблю тебя всё сильнее...
                                </div>
                                <div style="font-family: 'Caveat', cursive; font-size: 18px; color: #999; line-height: 1.4;">
                                    Эта открытка — лишь маленькая часть моих чувств. Каждая её страница хранит в себе частичку нашей любви.
                                </div>
                            </div>
                        </div>
                    </div>
                    <div style="margin-top: 30px; font-family: 'Caveat', cursive; font-size: 18px; color: rgba(255, 255, 255, 0.7);">
                        Нажми на открытку, чтобы продолжить
                    </div>
                </div>
            </div>

            <!-- СТРАНИЦА 2: БОЛТ -->
            <div class="page" id="page2">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 20px; color: var(--primary);">
                        Открути болт
                    </h2>
                    <p style="font-family: 'Caveat', cursive; font-size: 20px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
                        Покрути против часовой стрелки, чтобы снять защитный щит
                    </p>
                    <div class="shield-container">
                        <div class="shield" id="shield">
                            <div class="bolt-hole">
                                <div class="bolt-direction">↺</div>
                                <div class="bolt" id="bolt"></div>
                            </div>
                        </div>
                        <div class="message-under-shield" id="message-under-shield">
                            Ты смогла!<br>Моё сердце открыто для тебя ❤️
                        </div>
                    </div>
                    <div style="margin-top: 20px; font-family: 'Caveat', cursive; font-size: 18px; color: rgba(255, 255, 255, 0.7);">
                        Крути болт пальцем против часовой стрелки
                    </div>
                </div>
            </div>

            <!-- СТРАНИЦА 3: СТИРАНИЕ -->
            <div class="page" id="page3">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 20px; color: var(--primary);">
                        Сотри туман
                    </h2>
                    <p style="font-family: 'Caveat', cursive; font-size: 20px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
                        Проведи пальцем, чтобы стереть размытие
                    </p>
                    <div class="scratch-container">
                        <!--<img src="https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80" -->
                            <img src="https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80"
                             class="scratch-image" id="scratch-image">
                        <div class="scratch-overlay" id="scratch-overlay"></div>
                        <div class="scratch-text">Сотри меня...</div>
                        <canvas class="scratch-canvas" id="scratch-canvas"></canvas>
                    </div>
                    <div class="scratch-percent" id="scratch-percent">Стерто: 0%</div>
                </div>
            </div>

            <!-- СТРАНИЦА 4: ВСТРЯХНУТЬ -->
            <div class="page" id="page4">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 20px; color: var(--primary);">
                        Стряхни тайну
                    </h2>
                    <p style="font-family: 'Caveat', cursive; font-size: 20px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
                        Потряси телефон или нажми кнопку
                    </p>
                    <div class="shake-container">
                        <img src="https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80" class="shake-image" id="shake-image">
                        <!--<img src="https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80">-->
                        <div class="shake-overlay" id="shake-overlay"></div>
                    </div>
                    <button class="shake-button" id="shake-button" >Стряхнуть размытие (0/5)</button>
                    <p style="margin-top: 20px; font-family: 'Caveat', cursive; font-size: 18px; color: rgba(255, 255, 255, 0.7);">
                        На телефоне: просто потряси устройство
                    </p>
                </div>
            </div>

            <!-- СТРАНИЦА 5: ПАЗЛ -->
            <div class="page" id="page5">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 20px; color: var(--primary);">
                        Собери сердечко
                    </h2>
                    <p style="font-family: 'Caveat', cursive; font-size: 20px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
                        Перетащи фрагменты на место, чтобы собрать сердце
                    </p>
                    <div class="puzzle-area" id="puzzle"></div>
                    <p style="margin-top: 20px; font-family: 'Caveat', cursive; font-size: 18px; color: var(--primary);">
                        Нажми на кусочек и перетащи его!
                    </p>
                </div>
            </div>

            <!-- СТРАНИЦА 6: ГАЛЕРЕЯ -->
            <div class="page" id="page6">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 20px; color: var(--primary);">
                        Наши моменты
                    </h2>
                    <p style="font-family: 'Caveat', cursive; font-size: 20px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
                        Листай фото внизу
                    </p>
                    <div class="gallery-container" id="gallery-container">
                        <div class="gallery-slide active" style="background-image: url('https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80');">
                            <div style="background: rgba(0,0,0,0.6); padding: 15px; border-radius: 15px; margin-top: 250px;">
                                <div style="font-family: 'Caveat', cursive; font-size: 22px; color: white;">Наше первое свидание ❤️</div>
                            </div>
                        </div>
                        <div class="gallery-slide" style="background-image: url('https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80');">
                            <div style="background: rgba(0,0,0,0.6); padding: 15px; border-radius: 15px; margin-top: 250px;">
                                <div style="font-family: 'Caveat', cursive; font-size: 22px; color: white;">Самые теплые моменты</div>
                            </div>
                        </div>
                        <div class="gallery-slide" style="background-image: url('https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80');">
                            <div style="background: rgba(0,0,0,0.6); padding: 15px; border-radius: 15px; margin-top: 250px;">
                                <div style="font-family: 'Caveat', cursive; font-size: 22px; color: white;">Будущее с тобой</div>
                            </div>
                        </div>
                    </div>
                    <div class="gallery-nav" id="gallery-nav"></div>
                </div>
            </div>

            <!-- СТРАНИЦА 7: СЕРДЕЧНЫЙ ВЗРЫВ -->
            <div class="page" id="page7">
                <div class="page-content">
                    <h2 style="font-family: 'Marck Script', cursive; font-size: 32px; margin-bottom: 20px; color: var(--primary);">
                        Сердечный взрыв
                    </h2>
                    <p style="font-family: 'Caveat', cursive; font-size: 20px; margin-bottom: 20px; color: rgba(255, 255, 255, 0.9);">
                        Нажимай на сердце, чтобы наполнить его любовью
                    </p>
                    <div class="hearts-container" id="hearts-container">
                        <div class="main-heart" id="main-heart"></div>
                    </div>
                    <div class="tap-counter" id="tap-counter">
                        Нажми на сердце! Осталось: 10
                    </div>
                </div>
            </div>

            <!-- СТРАНИЦА 8: ФИНАЛ -->
            <div class="page" id="page8">
                <div class="page-content">
                    <h2 style="font-family: 'Great Vibes', cursive; font-size: 42px; margin-bottom: 20px; color: var(--primary);">
                        Для тебя, моя любовь
                    </h2>
                    <div class="final-message">
                        <div class="final-heart">❤️</div>
                        <div style="font-family: 'Dancing Script', cursive; font-size: 28px; margin-bottom: 15px; color: white;">
                            С Днём Святого Валентина!
                        </div>
                        <div style="font-family: 'Caveat', cursive; font-size: 24px; line-height: 1.6; color: rgba(255, 255, 255, 0.9); margin-bottom: 30px;">
                            Ты — самый прекрасный подарок в моей жизни.<br>
                            Каждый день с тобой наполнен счастьем,<br>
                            смехом и бесконечной любовью.<br><br>
                            Спасибо тебе за всё, что ты есть.<br>
                            Я люблю тебя больше, чем слова могут выразить.
                        </div>

                        <button class="download-btn" id="downloadBtn" >
                            Скачать открытку ❤️
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- НАВИГАЦИЯ -->
        <div class="nav-buttons">
            <button class="nav-btn" id="prev-btn">←</button>
            <button class="nav-btn" id="next-btn">→</button>
        </div>
    </div>

    <!-- КОНФЕТТИ -->
    <div class="confetti" id="confetti"></div>

    <script>
        // ==================== СИСТЕМА ЛОГИРОВАНИЯ ====================
        const LogSystem = {
            panel: null,
            enabled: true, // Включить/выключить логи
            maxEntries: 50,

            init() {
                this.panel = document.getElementById('log-panel');
                // Показать панель логов при двойном клике в правом верхнем углу
                document.addEventListener('dblclick', (e) => {
                    if (e.clientX > window.innerWidth - 100 && e.clientY < 100) {
                        this.panel.style.display = this.panel.style.display === 'none' ? 'block' : 'none';
                    }
                });

                this.log('info', 'Система логирования запущена');
            },

            log(type, message) {
                if (!this.enabled) return;

                const entry = document.createElement('div');
                entry.className = `log-entry log-${type}`;
                entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;

                this.panel.appendChild(entry);

                // Ограничить количество записей
                const entries = this.panel.querySelectorAll('.log-entry');
                if (entries.length > this.maxEntries) {
                    entries[0].remove();
                }

                // Прокрутить вниз
                this.panel.scrollTop = this.panel.scrollHeight;

                // Также выводим в консоль
                console.log(`[${type.toUpperCase()}] ${message}`);
            },

            error(message) { this.log('error', message); },
            success(message) { this.log('success', message); },
            warning(message) { this.log('warning', message); },
            info(message) { this.log('info', message); }
        };

        // КОНФИГУРАЦИЯ
        const CONFIG = {
            PASSWORD: '1',
            TOTAL_PAGES: 8,
            SCRATCH_THRESHOLD: 50,
            SHAKE_ACTIONS_REQUIRED: 5,
            HEART_TAPS_REQUIRED: 10
        };

        // СОСТОЯНИЕ
        let currentPage = 0;
        let isDraggingPuzzle = false;
        let scratchPercent = 0;
        let heartTaps = 0;
        let shakeActions = 0;
        let pageCompleted = {
            1: false, 2: false, 3: false, 4: false,
            5: false, 6: true, 7: false, 8: true
        };

        // ЭЛЕМЕНТЫ
        const passwordScreen = document.getElementById('password-screen');
        const mainScreen = document.getElementById('main-screen');
        const passwordInput = document.getElementById('password-input');
        const submitBtn = document.getElementById('submit-btn');
        const pages = document.querySelectorAll('.page');
        const indicatorDots = document.querySelectorAll('.indicator-dot');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');

        // ИНИЦИАЛИЗАЦИЯ
        function init() {
            LogSystem.init();
            LogSystem.info('Приложение запускается...');

            // Фокус на поле ввода (с задержкой для мобильных)
            setTimeout(() => {
                passwordInput.focus();
                LogSystem.info('Фокус установлен на поле ввода пароля');
            }, 500);

            // Обработчики пароля
            submitBtn.addEventListener('click', checkPassword);
            passwordInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') checkPassword();
            });

            // Обработчики навигации
            prevBtn.addEventListener('click', goToPrevPage);
            nextBtn.addEventListener('click', goToNextPage);

            // Инициализация свайпов
            initSwipe();

            // Запрос разрешения на гироскоп для iOS
            if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
                DeviceMotionEvent.requestPermission().then(response => {
                    if (response === 'granted') {
                        LogSystem.success('Разрешение на гироскоп получено');
                    }
                });
            }

            LogSystem.success('Инициализация завершена');
        }

        // ПАРОЛЬ
        function checkPassword() {
            const input = passwordInput.value.trim().toLowerCase();
            LogSystem.info(`Проверка пароля: "${input}"`);

            if (input === CONFIG.PASSWORD) {
                LogSystem.success('Пароль верный!');
                showSuccessAnimation();
                setTimeout(() => {
                    passwordScreen.style.display = 'none';
                    mainScreen.style.display = 'flex';
                    showPage(0);
                    createConfetti();
                    playSound('success');
                }, 1500);
            } else {
                LogSystem.error('Неверный пароль');
                showErrorAnimation();
            }
        }

        function showSuccessAnimation() {
            submitBtn.style.background = 'linear-gradient(45deg, #00ff88, #00cc66)';
            submitBtn.innerHTML = '✓ Успех!';

            const heart = document.querySelector('.heart-icon');
            heart.style.background = 'linear-gradient(45deg, #00ff88, #00cc66)';

            createConfettiAtElement(passwordScreen);
        }

        function showErrorAnimation() {
            const input = passwordInput;
            input.style.animation = 'shake 0.5s';
            input.style.borderColor = '#ff3366';
            input.style.boxShadow = '0 0 30px rgba(255, 51, 102, 0.6)';

            setTimeout(() => {
                input.style.animation = '';
                input.style.borderColor = 'rgba(255, 255, 255, 0.4)';
                input.style.boxShadow = 'none';
            }, 500);

            playSound('error');
        }

        // НАВИГАЦИЯ - ИСПРАВЛЕНО: НЕТ АВТОПЕРЕХОДА
        function initSwipe() {
            let startX = 0;
            let startY = 0;
            let isSwiping = false;

            document.addEventListener('touchstart', (e) => {
                if (isDraggingPuzzle) return;
                startX = e.touches[0].clientX;
                startY = e.touches[0].clientY;
                isSwiping = true;
            });

            document.addEventListener('touchmove', (e) => {
                if (!isSwiping || isDraggingPuzzle) return;
                e.preventDefault();
            });

            document.addEventListener('touchend', (e) => {
                if (!isSwiping || isDraggingPuzzle) return;
                isSwiping = false;

                const endX = e.changedTouches[0].clientX;
                const endY = e.changedTouches[0].clientY;
                const diffX = endX - startX;
                const diffY = endY - startY;

                if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                    if (diffX > 0) {
                        goToPrevPage();
                    } else {
                        goToNextPage();
                    }
                }
            });

            // Клавиши клавиатуры
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') goToPrevPage();
                if (e.key === 'ArrowRight') goToNextPage();
                if (e.key === 'Escape') passwordInput.focus();
            });
        }

        function showPage(index) {
            if (index < 0 || index >= CONFIG.TOTAL_PAGES) return;

            LogSystem.info(`Переход на страницу ${index + 1}`);

            // Скрываем текущую страницу
            pages[currentPage].classList.remove('active');
            if (index < currentPage) {
                pages[currentPage].classList.add('prev');
            }
            pages[currentPage].classList.remove('prev');

            // Показываем новую страницу
            currentPage = index;
            pages[currentPage].classList.add('active');

            updateNavigation();
            updatePageIndicator();

            // Инициализация конкретной страницы
            switch(currentPage) {
                case 0: initCardPage(); break;
                case 1: initBoltPage(); break;
                case 2: initScratchPage(); break;
                case 3: initShakePage(); break;
                case 4: initPuzzlePage(); break;
                case 5: initGalleryPage(); break;
                case 6: initHeartExplosionPage(); break;
                case 7: initFinalPage(); break;
            }
        }

        function goToPrevPage() {
            if (currentPage > 0) {
                showPage(currentPage - 1);
            }
        }

        function goToNextPage() {
            // Проверяем, выполнено ли задание на текущей странице
            

            if (currentPage < CONFIG.TOTAL_PAGES - 1) {
                showPage(currentPage + 1);
            }
        }

        function updateNavigation() {
            prevBtn.disabled = currentPage === 0;
            nextBtn.disabled = currentPage === CONFIG.TOTAL_PAGES - 1;
        }

        function updatePageIndicator() {
            indicatorDots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentPage);
            });
        }

        // СТРАНИЦА 1: ОТКРЫТКА - ИСПРАВЛЕНО
        function initCardPage() {
            const card = document.getElementById('card');
            card.classList.remove('open');

            const openCard = () => {
                card.classList.add('open');
                playSound('open');
                pageCompleted[0] = true;
                LogSystem.success('Открытка открыта');
            };

            card.addEventListener('click', openCard);

            // Свайп для открытия
            let cardStartX = 0;
            card.addEventListener('touchstart', (e) => {
                cardStartX = e.touches[0].clientX;
            });

            card.addEventListener('touchend', (e) => {
                const endX = e.changedTouches[0].clientX;
                if (endX - cardStartX < -50) {
                    openCard();
                }
            });

            LogSystem.info('Страница 1: Открытка инициализирована');
        }

        // СТРАНИЦА 2: БОЛТ
        function initBoltPage() {
            const bolt = document.getElementById('bolt');
            const shield = document.getElementById('shield');
            const message = document.getElementById('message-under-shield');
            let rotation = 0;
            let isDragging = false;
            let startAngle = 0;

            const startDrag = (e) => {
                isDragging = true;
                const rect = bolt.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                startAngle = Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;

                const moveHandler = (e) => drag(e);
                const endHandler = () => stopDrag();

                document.addEventListener('mousemove', moveHandler);
                document.addEventListener('touchmove', moveHandler);
                document.addEventListener('mouseup', endHandler);
                document.addEventListener('touchend', endHandler);
            };

            const drag = (e) => {
                if (!isDragging) return;

                const rect = bolt.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;
                const clientX = e.type.includes('mouse') ? e.clientX : e.touches[0].clientX;
                const clientY = e.type.includes('mouse') ? e.clientY : e.touches[0].clientY;
                const angle = Math.atan2(clientY - centerY, clientX - centerX) * 180 / Math.PI;

                let delta = angle - startAngle;
                if (delta > 180) delta -= 360;
                if (delta < -180) delta += 360;

                // Только против часовой стрелки
                if (delta < 0) {
                    rotation += delta;
                    bolt.style.transform = `rotate(${rotation}deg)`;

                    if (rotation < -360) {
                        boltComplete();
                    }
                }

                startAngle = angle;
            };

            const stopDrag = () => {
                isDragging = false;
                const moveHandler = (e) => drag(e);
                const endHandler = () => stopDrag();

                document.removeEventListener('mousemove', moveHandler);
                document.removeEventListener('touchmove', moveHandler);
                document.removeEventListener('mouseup', endHandler);
                document.removeEventListener('touchend', endHandler);
            };

            const boltComplete = () => {
                isDragging = false;
                bolt.style.transition = 'transform 0.5s';
                bolt.style.transform = 'rotate(-720deg) scale(0.8)';

                setTimeout(() => {
                    message.classList.add('show');
                    playSound('success');
                    pageCompleted[1] = true;
                    LogSystem.success('Болт откручен');

                    setTimeout(() => {
                        shield.classList.add('fall-off');
                        createConfetti();
                    }, 1000);
                }, 500);
            };

            bolt.addEventListener('mousedown', startDrag);
            bolt.addEventListener('touchstart', startDrag);

            LogSystem.info('Страница 2: Болт инициализирован');
        }

        // СТРАНИЦА 3: СТИРАНИЕ
        function initScratchPage() {
            const canvas = document.getElementById('scratch-canvas');
            const ctx = canvas.getContext('2d');
            const container = document.querySelector('.scratch-container');
            const overlay = document.getElementById('scratch-overlay');
            const percentText = document.getElementById('scratch-percent');
            const image = document.getElementById('scratch-image');

            // Устанавливаем размеры канваса
            canvas.width = container.offsetWidth;
            canvas.height = container.offsetHeight;

            // Заполняем канвас черным цветом
            ctx.fillStyle = 'rgba(0, 0, 0, 1)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.globalCompositeOperation = 'destination-out';

            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            const startDrawing = (e) => {
                isDrawing = true;
                const pos = getPosition(e);
                [lastX, lastY] = [pos.x, pos.y];
                draw(e);
            };

            const draw = (e) => {
                if (!isDrawing) return;

                e.preventDefault();
                const pos = getPosition(e);

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(pos.x, pos.y);
                ctx.lineWidth = 40;
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.stroke();

                [lastX, lastY] = [pos.x, pos.y];

                updateScratchPercent();
            };

            const stopDrawing = () => {
                isDrawing = false;
            };

            const getPosition = (e) => {
                const rect = canvas.getBoundingClientRect();
                const clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                const clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                return {
                    x: clientX - rect.left,
                    y: clientY - rect.top
                };
            };

            const updateScratchPercent = () => {
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const pixels = imageData.data;
                let transparentPixels = 0;

                for (let i = 3; i < pixels.length; i += 4) {
                    if (pixels[i] === 0) transparentPixels++;
                }

                scratchPercent = Math.round((transparentPixels / (pixels.length / 4)) * 100);
                percentText.textContent = `Стерто: ${scratchPercent}%`;

                // Уменьшаем непрозрачность оверлея
                overlay.style.opacity = (100 - scratchPercent) / 100;

                // Уменьшаем размытие изображения
                const blurAmount = 15 - (scratchPercent / 100) * 15;
                image.style.filter = `blur(${blurAmount}px)`;

                if (scratchPercent >= CONFIG.SCRATCH_THRESHOLD && !pageCompleted[2]) {
                    finishScratching();
                }
            };

            const finishScratching = () => {
                pageCompleted[2] = true;
                canvas.style.opacity = '0';
                overlay.style.opacity = '0';
                image.style.filter = 'blur(0)';
                let ele = document.querySelector('.scratch-text')
                ele.textContent = '';

                playSound('success');
                createConfetti();
                LogSystem.success('Стирание завершено');

                // Стираем весь холст для показа изображения
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                scratchPercent = 100;
                percentText.textContent = `Стерто: 100%`;
            };

            // Назначаем события
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseleave', stopDrawing);

            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);

            LogSystem.info('Страница 3: Стирание инициализировано');
        }

        // СТРАНИЦА 4: ВСТРЯХНУТЬ - ИСПРАВЛЕНО
        // ==== РЕПЛЕЙС: initShakePage ====
// Страница 4: Стряхни тайну – исправленная версия
function initShakePage() {
    // Находим элементы
    console.log('initShakePage called');
    const button = document.getElementById('shake-button');
    const image = document.getElementById('shake-image');
    const overlay = document.getElementById('shake-overlay');
    console.log('Elements:', { button, image, overlay });

    if (!button || !image || !overlay) {
        LogSystem?.error('initShakePage: элементы не найдены');
        return;
    }

    // Если страница уже была пройдена – сразу показываем открытый результат
    if (pageCompleted[4]) {
        console.log('Страница 4 уже выполнена, устанавливаем финальное состояние');
        image.style.filter = 'blur(0)';
        overlay.style.clipPath = 'inset(0%)';
        overlay.style.opacity = '0';
        button.disabled = true;
        button.textContent = 'Готово!';
        return; // завершаем инициализацию, обработчики не навешиваем
    }

    // Убираем инлайн-обработчик, если он есть
    button.removeAttribute('onclick');

    // Состояние страницы (храним глобально для совместимости с другими частями)
    window._shakeState = window._shakeState || {
        actions: 0,
        required: CONFIG.SHAKE_ACTIONS_REQUIRED || 5,
        lastShakeTime: 0,
        history: []
    };
    const state = window._shakeState;

    // Сбрасываем прогресс при каждом открытии страницы (если нужно)
    state.actions = 0;
    state.history = [];

    // Начальные стили
    image.style.transition = 'filter 0.3s ease';
    image.style.filter = 'blur(20px)';

    overlay.style.transition = 'clip-path 0.3s ease, opacity 0.3s ease';
    overlay.style.clipPath = 'inset(50% 50% 50% 50%)'; // полностью закрыто
    overlay.style.opacity = '1';
    overlay.style.pointerEvents = 'none';

    // Функция обновления UI
    function updateUI() {
        const progress = state.actions / state.required;
        const blurAmount = 20 * (1 - progress);
        image.style.filter = `blur(${blurAmount}px)`;

        const insetPercent = 50 * (1 - progress);
        overlay.style.clipPath = `inset(${insetPercent}% ${insetPercent}% ${insetPercent}% ${insetPercent}%)`;
        overlay.style.opacity = 1 - progress * 0.8; // плавно исчезает

        button.textContent = `Стряхнуть размытие (${state.actions}/${state.required})`;
    }

    // Функция, выполняемая при одном действии (нажатие или тряска)
    function applyAction() {
        console.log('applyAction called, actions before:', state.actions);
        if (state.actions >= state.required) return;

        state.actions++;
        updateUI();

        // Визуальная обратная связь
        image.style.transform = 'scale(1.02)';
        setTimeout(() => image.style.transform = 'scale(1)', 150);

        // Вибрация (если поддерживается)
        if (navigator.vibrate) navigator.vibrate(50);

        // Если достигнут лимит – завершаем
        if (state.actions >= state.required) {
            overlay.style.transition = 'opacity 0.5s';
            overlay.style.opacity = '0';
            image.style.filter = 'blur(0)';
            button.disabled = true;
            button.textContent = 'Готово!';
            //pageCompleted[3] = true;
            pageCompleted[4] = true;
            LogSystem?.success('ShakePage завершена');
            createConfetti(); // добавим конфетти для радости
        }
    }

    // Обработчик клика по кнопке
    button.addEventListener('click', applyAction);

    // ----- Обработка тряски (devicemotion) -----
    async function setupMotionListener() {
        // Запрос разрешения для iOS
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            try {
                const response = await DeviceMotionEvent.requestPermission();
                if (response !== 'granted') {
                    LogSystem?.warn('Доступ к гироскопу не разрешён');
                    return;
                }
            } catch (err) {
                LogSystem?.error('Ошибка запроса разрешения: ' + err);
                return;
            }
        }

        // Проверка поддержки devicemotion
        if (!window.DeviceMotionEvent) {
            LogSystem?.warn('devicemotion не поддерживается');
            return;
        }

        let lastShake = 0;
        const SHAKE_THRESHOLD = 5; // можно подобрать опытным путём
        const MIN_TIME_BETWEEN_SHAKES = 500; // мс

        function motionHandler(event) {
            const acc = event.accelerationIncludingGravity;
            if (!acc) return;

            const now = Date.now();
            if (now - lastShake < MIN_TIME_BETWEEN_SHAKES) return;

            const magnitude = Math.sqrt(acc.x * acc.x + acc.y * acc.y + acc.z * acc.z);
            // Сохраняем последние несколько значений для сглаживания
            state.history.push(magnitude);
            if (state.history.length > 5) state.history.shift();

            const avg = state.history.reduce((a, b) => a + b, 0) / state.history.length;
            if (avg > SHAKE_THRESHOLD) {
                lastShake = now;
                applyAction();
            }
        }

        window.addEventListener('devicemotion', motionHandler);

        // Очистка при уходе со страницы (если нужно)
        return () => window.removeEventListener('devicemotion', motionHandler);
    }

    // Запускаем настройку motionListener
    setupMotionListener().catch(e => LogSystem?.error('Motion setup error: ' + e));

    // Первоначальное обновление UI
    updateUI();

    LogSystem?.info('Страница 4 (тряска) успешно инициализирована');
}




        // СТРАНИЦА 5: ПАЗЛ - ИСПРАВЛЕН (твой код)
        function initPuzzlePage() {
            const puzzle = document.getElementById('puzzle');
            puzzle.innerHTML = '';

            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.src = 'https://images.unsplash.com/photo-1518568814500-bf0f8d125f46?ixlib=rb-1.2.1&auto=format&fit=crop&w=600&q=80';

            img.onload = () => {
                LogSystem.info('Изображение пазла загружено');

                const canvas = document.createElement('canvas');
                canvas.width = 300;
                canvas.height = 300;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, 300, 300);

                let pieces = [];
                const size = 3;
                const pieceW = 100;
                const pieceH = 100;

                // Создаем кусочки пазла
                for (let r = 0; r < size; r++) {
                    for (let c = 0; c < size; c++) {
                        const px = c * pieceW;
                        const py = r * pieceH;
                        const data = ctx.getImageData(px, py, pieceW, pieceH);

                        const pCanvas = document.createElement('canvas');
                        pCanvas.width = pieceW;
                        pCanvas.height = pieceH;
                        pCanvas.getContext('2d').putImageData(data, 0, 0);

                        const url = pCanvas.toDataURL();
                        pieces.push({
                            id: r * size + c,
                            url
                        });
                    }
                }

                // Перемешиваем кусочки
                pieces = pieces.sort(() => Math.random() - 0.5);

                // Создаем элементы для кусочков
                pieces.forEach((p, idx) => {
                    const el = document.createElement('div');
                    el.className = 'puzzle-piece';
                    el.draggable = true;
                    el.style.backgroundImage = `url(${p.url})`;
                    el.dataset.id = p.id;
                    el.dataset.pos = idx;

                    el.addEventListener('dragstart', (e) => {
                        e.dataTransfer.setData('text/plain', e.target.dataset.id);
                    });

                    el.addEventListener('dragover', (e) => {
                        e.preventDefault();
                    });

                    el.addEventListener('drop', (e) => {
                        e.preventDefault();
                        const sourceId = e.dataTransfer.getData('text/plain');
                        const targetId = e.target.dataset.id;

                        const sourceEl = Array.from(puzzle.children).find(x => x.dataset.id === sourceId);
                        const targetEl = e.target;

                        // Меняем местами backgroundImage
                        const tmpBg = sourceEl.style.backgroundImage;
                        sourceEl.style.backgroundImage = targetEl.style.backgroundImage;
                        targetEl.style.backgroundImage = tmpBg;

                        // Меняем местами dataset.id
                        const tmpD = sourceEl.dataset.id;
                        sourceEl.dataset.id = targetEl.dataset.id;
                        targetEl.dataset.id = tmpD;

                        checkPuzzleSolved();
                    });

                    puzzle.appendChild(el);
                });
            };

            img.onerror = () => {
                LogSystem.error('Ошибка загрузки изображения пазла');
                // Запасной вариант
                for (let i = 0; i < 9; i++) {
                    const el = document.createElement('div');
                    el.className = 'puzzle-piece';  //отличие
                    el.style.backgroundImage = 'linear-gradient(135deg, var(--accent), var(--accent2))';
                    el.draggable = true; //отличие

                    el.addEventListener('dragstart', (e) => {  //отличие
                        e.dataTransfer.setData('text/plain', i);
                    });

                    puzzle.appendChild(el);
                }
            };

            function checkPuzzleSolved() {
                const pieces = Array.from(puzzle.children);
                let ok = true;

                pieces.forEach((el, idx) => {
                    if (!el.dataset.id || Number(el.dataset.id) !== idx) {
                        ok = false;
                    }
                });

                if (ok && !pageCompleted[4]) {
                    pageCompleted[4] = true;
                    createConfetti();
                    playSound('success');
                    LogSystem.success('Пазл собран!');
                    setTimeout(() => {
                        alert('Сердечко собрано ❤️');
                    }, 200);
                }
            }

            LogSystem.info('Страница 5: Пазл инициализирован');
        }
        //initPuzzlePage();

        // СТРАНИЦА 6: ГАЛЕРЕЯ - УБРАН АВТОСКРОЛЛ
        function initGalleryPage() {
            const slides = document.querySelectorAll('.gallery-slide');
            const nav = document.getElementById('gallery-nav');
            let currentSlide = 0;

            // Очищаем навигацию
            nav.innerHTML = '';

            // Создаем точки навигации
            slides.forEach((_, index) => {
                const dot = document.createElement('div');
                dot.className = `gallery-dot ${index === 0 ? 'active' : ''}`;
                dot.dataset.index = index;
                dot.addEventListener('click', (e) => {
                    e.stopPropagation();
                    showSlide(parseInt(e.target.dataset.index));
                });
                nav.appendChild(dot);
            });

            function showSlide(index) {
                slides[currentSlide].classList.remove('active');
                nav.children[currentSlide].classList.remove('active');

                currentSlide = index;

                slides[currentSlide].classList.add('active');
                nav.children[currentSlide].classList.add('active');
            }

            // Обработчики свайпов только для галереи
            const gallery = document.getElementById('gallery-container');
            let galleryStartX = 0;

            gallery.addEventListener('touchstart', (e) => {
                galleryStartX = e.touches[0].clientX;
                e.stopPropagation();
            });

            gallery.addEventListener('touchend', (e) => {
                const endX = e.changedTouches[0].clientX;
                const diff = galleryStartX - endX;

                if (Math.abs(diff) > 50) {
                    if (diff > 0 && currentSlide < slides.length - 1) {
                        showSlide(currentSlide + 1);
                    } else if (diff < 0 && currentSlide > 0) {
                        showSlide(currentSlide - 1);
                    }
                }

                e.stopPropagation();
            });

            LogSystem.info('Страница 6: Галерея инициализирована (автоскролл отключен)');
        }

        // СТРАНИЦА 7: СЕРДЕЧНЫЙ ВЗРЫВ - ИСПРАВЛЕН
        function initHeartExplosionPage() {
            const mainHeart = document.getElementById('main-heart');
            const container = document.getElementById('hearts-container') || document.body;
            const tapCounter = document.getElementById('tap-counter');

            // сохраняем состояние на window, чтобы при перелистывании можно было читать/менять
            window.__heartPageState = window.__heartPageState || { pageActive: false, exploded: false };
            window.__heartPageState.pageActive = true;
            // если глобально уже помечено как выполненная — приводим в соответствие
            window.__heartPageState.exploded = Boolean(window.__heartPageState.exploded || (pageCompleted && !pageCompleted[6]));

            // -------------------- UI helpers --------------------
            function updateTapCounter() {
                if (!tapCounter) return;
                const remaining = Math.max(0, (CONFIG && CONFIG.HEART_TAPS_REQUIRED ? CONFIG.HEART_TAPS_REQUIRED : 10) - (heartTaps || 0));
                tapCounter.textContent = `Нажми на сердце! Осталось: ${remaining}`;

                const intensity = (heartTaps || 0) / (CONFIG && CONFIG.HEART_TAPS_REQUIRED ? CONFIG.HEART_TAPS_REQUIRED : 10);
                const red = Math.floor(255 * intensity);
                const color = `rgb(${red}, ${Math.floor(100 - 90 * intensity)}, ${Math.floor(150 - 100 * intensity)})`;
                if (mainHeart) mainHeart.style.background = color;
            }

            function createHeartParticle() {
                if (!mainHeart || !container) return;
                const particle = document.createElement('div');
                particle.style.position = 'absolute';
                particle.style.width = '18px';
                particle.style.height = '18px';
                const bg = mainHeart.style.background || getComputedStyle(mainHeart).backgroundColor || 'var(--primary)';
                particle.style.background = bg;
                particle.style.borderRadius = '50%';
                particle.style.top = '50%';
                particle.style.left = '50%';
                particle.style.transform = 'translate(-50%, -50%)';
                particle.style.pointerEvents = 'none';
                container.appendChild(particle);

                const angle = Math.random() * Math.PI * 2;
                const distance = 40 + Math.random() * 120;
                const duration = 400 + Math.random() * 600;

                const toX = Math.cos(angle) * distance;
                const toY = Math.sin(angle) * distance;

                particle.animate([
                    { transform: 'translate(-50%, -50%) scale(1)', opacity: 1 },
                    { transform: `translate(calc(-50% + ${toX}px), calc(-50% + ${toY}px)) scale(0)`, opacity: 0 }
                ], {
                    duration: duration,
                    easing: 'cubic-bezier(0.2, 0, 0.8, 1)',
                    fill: 'forwards'
                });

                setTimeout(() => particle.remove(), duration);
            }

            // -------------------- Безье-самплинг --------------------
            function cubicBezierPoint(t, p0, p1, p2, p3) {
                const u = 1 - t;
                const tt = t * t;
                const uu = u * u;
                const uuu = uu * u;
                const ttt = tt * t;
                const x = uuu * p0.x + 3 * uu * t * p1.x + 3 * u * tt * p2.x + ttt * p3.x;
                const y = uuu * p0.y + 3 * uu * t * p1.y + 3 * u * tt * p2.y + ttt * p3.y;
                return { x, y };
            }

            // -------------------- Улучшённый взрыв --------------------
            function createHeartExplosion(opts = {}) {
                if (!mainHeart || !container) return;

                const {
                    count = 57,
                    durationMin = 3000,
                    durationMax = 7000,
                    maxDistance = 1160,
                    curveOffset = 9800,
                    steps = 500 // число ключевых кадров для каждой кривой (чем больше — тем плавнее)
                } = opts;

                // помечаем как выполненное и запрещаем дальнейшие клики
                window.__heartPageState.exploded = true;
                if (pageCompleted) pageCompleted[6] = true;
                mainHeart.style.pointerEvents = 'none';

                const rect = mainHeart.getBoundingClientRect();
                const startX = rect.left + rect.width / 2;
                const startY = rect.top + rect.height / 2;
                const emojis = ['❤️','💖','💕','💗','💓','💞','💘','✨','🌟','🎉'];

                for (let i = 0; i < count; i++) {
                    const el = document.createElement('div');
                    el.className = 'expl-emoji';
                    el.style.position = 'fixed';
                    el.style.left = `${startX}px`;
                    el.style.top = `${startY}px`;
                    el.style.transform = 'translate(-50%,-50%)';
                    el.style.pointerEvents = 'none';
                    el.style.fontSize = `${14 + Math.round(Math.random() * 22)}px`;
                    el.textContent = emojis[Math.floor(Math.random() * emojis.length)];
                    container.appendChild(el);

                    const angle = Math.random() * Math.PI * 2;
                    const dist = (maxDistance * (0.4 + Math.random() * 0.6)); // от 40% до 100%
                    const endX = startX + Math.cos(angle) * dist;
                    const endY = startY + Math.sin(angle) * dist - (20 + Math.random() * 80); // чуть вверх

                    const cp1 = {
                        x: startX + Math.cos(angle - 0.6) * (dist * (0.2 + Math.random() * 0.2)) + (Math.random() - 0.5) * curveOffset,
                        y: startY + Math.sin(angle - 0.6) * (dist * (0.2 + Math.random() * 0.2)) + (Math.random() - 0.5) * curveOffset
                    };
                    const cp2 = {
                        x: startX + Math.cos(angle + 0.6) * (dist * (0.6 + Math.random() * 0.25)) + (Math.random() - 0.5) * curveOffset,
                        y: startY + Math.sin(angle + 0.6) * (dist * (0.6 + Math.random() * 0.25)) + (Math.random() - 0.5) * curveOffset
                    };

                    const duration = Math.round(durationMin + Math.random() * (durationMax - durationMin));

                    // собираем ключевые кадры, сэмплируя кривую в 'steps' точках
                    const frames = [];
                    for (let s = 0; s <= steps; s++) {
                        const t = s / steps;
                        const p = cubicBezierPoint(t,
                            { x: startX, y: startY },
                            cp1, cp2,
                            { x: endX, y: endY }
                        );
                        const relX = p.x - startX;
                        const relY = p.y - startY;
                        const scale = 1 - 0.6 * t;
                        const rot = Math.round(720 * t * (Math.random() > 0.5 ? 1 : -1));
                        frames.push({
                            transform: `translate(${relX}px, ${relY}px) translate(-50%,-50%) scale(${scale}) rotate(${rot}deg)`,
                            offset: t,
                            opacity: 1 - t
                        });
                    }

                    const anim = el.animate(frames, {
                        duration: duration,
                        easing: 'cubic-bezier(.2,.7,.2,1)',
                        fill: 'forwards'
                    });

                    anim.onfinish = () => { try { el.remove(); } catch (e) {} };
                }

                // плавное исчезновение основного сердца
                mainHeart.animate([
                    { transform: 'scale(1)', opacity: 1 },
                    { transform: 'scale(0.6)', opacity: 0 }
                ], { duration: 500, easing: 'ease-in', fill: 'forwards' });

                // дополнительные эффекты, если присутствуют
                if (typeof createConfetti === 'function') createConfetti();
                if (typeof playSound === 'function') playSound('explosion');
            }

            // -------------------- Взрывный вызов --------------------
            function explodeHeart() {
                // окончательно блокируем обработчик и запускаем эффект
                if (mainHeart) {
                    try { mainHeart.removeEventListener('pointerdown', tapHeart); } catch (e) {}
                }
                createHeartExplosion({
                    count: 57,
                    durationMin: 3000,
                    durationMax: 7000,
                    maxDistance: 716,
                    curveOffset: 350,
                    steps: 200
                });
                LogSystem && LogSystem.success && LogSystem.success('Сердце взорвано!');
            }

            // -------------------- Обработчик тапа --------------------
            let lastTapTime = 0;
            function tapHeart(e) {
                // блокируем если страница не активна или уже взорвано
                if (!window.__heartPageState || !window.__heartPageState.pageActive || window.__heartPageState.exploded) return;

                // допускаем только клики непосредственно по сердцу (или по его потомкам)
                if (!e.target || !e.target.closest || !e.target.closest('#main-heart')) return;

                e.preventDefault && e.preventDefault();
                const now = Date.now();
                if (now - lastTapTime < 40) return;
                lastTapTime = now;

                heartTaps = (typeof heartTaps === 'number') ? heartTaps + 1 : 1;
                updateTapCounter();

                // визуальный отклик
                if (mainHeart) {
                    mainHeart.style.animation = 'none';
                    setTimeout(() => { mainHeart.style.animation = 'pulse 0.5s'; }, 10);
                }
                createHeartParticle();
                if (typeof playSound === 'function') playSound('tap');

                const required = (CONFIG && CONFIG.HEART_TAPS_REQUIRED) ? CONFIG.HEART_TAPS_REQUIRED : 10;
                if (heartTaps >= required && !window.__heartPageState.exploded) {
                    explodeHeart();
                    // пометим, чтобы при последующих вызовах не допустить кликов по пустому месту
                    window.__heartPageState.exploded = true;
                    if (pageCompleted) pageCompleted[6] = true;
                }
            }

            // -------------------- Инициализация / навешивание --------------------
            // Если уже взорвано — сделаем сердечко недоступным и выйдем
            if (window.__heartPageState.exploded) {
                if (mainHeart) {
                    mainHeart.style.pointerEvents = 'none';
                    mainHeart.style.opacity = '0';
                }
                // всё: инициализация завершена — при возврате можно показать уже "взорванное" состояние
                return;
            }

            // сброс счётчика и обновление UI
            heartTaps = 0;
            updateTapCounter();

            // навешиваем pointerdown один раз
            mainHeart && mainHeart.addEventListener('pointerdown', tapHeart);

            // сохраняем функцию очистки (вызывать при уходе со страницы)
            window.__heartPageCleanup = function() {
                window.__heartPageState.pageActive = false;
                try { mainHeart && mainHeart.removeEventListener('pointerdown', tapHeart); } catch (e) {}
                // удаляем незавершённые эмодзи
                document.querySelectorAll('.expl-emoji').forEach(el => el.remove());
            };

            LogSystem && LogSystem.info && LogSystem.info('Страница 7: Сердечный взрыв инициализирован');
        }

// Деинициализация/вызвать при перелистывании со страницы
        function destroyHeartExplosionPage() {
            window.__heartPageState = window.__heartPageState || { pageActive: false, exploded: false };
            window.__heartPageState.pageActive = false;
            // оставляем exploded как есть (если уже был взрыв — сохраняем)
            try { if (typeof window.__heartPageCleanup === 'function') { window.__heartPageCleanup(); window.__heartPageCleanup = null; } } catch (e) {}
            // удалить визуальные остатки
            document.querySelectorAll('.expl-emoji').forEach(el => el.remove());
        }

        // СТРАНИЦА 8: ФИНАЛ
        function initFinalPage() {
            const downloadBtn = document.getElementById('downloadBtn');

            downloadBtn.addEventListener('click', generateCardImage);

            // Создаем конфетти
            createConfetti();

            LogSystem.info('Страница 8: Финальная страница инициализирована');
        }

        // ГЕНЕРАЦИЯ И СКАЧИВАНИЕ ОТКРЫТКИ
        function generateCardImage() {
            LogSystem.info('Начинается генерация открытки...');

            const c = document.createElement('canvas');
            c.width = 800;
            c.height = 1000;
            const ctx = c.getContext('2d');

            // Градиентный фон
            const grad = ctx.createLinearGradient(0, 0, 0, c.height);
            grad.addColorStop(0, '#fff3f6');
            grad.addColorStop(1, '#ffeaf0');
            ctx.fillStyle = grad;
            ctx.fillRect(0, 0, c.width, c.height);

            // Основной текст
            ctx.fillStyle = '#401323';
            ctx.font = 'bold 48px "Playfair Display", serif';
            ctx.textAlign = 'center';
            ctx.fillText('С Днём Святого Валентина', c.width / 2, 160);

            // Дополнительный текст
            ctx.font = '28px "Inter", sans-serif';
            wrapText(ctx, 'Я люблю тебя до Луны и обратно. Спасибо, что ты есть в моей жизни.', c.width / 2, 240, 660, 34);

            // Рисуем сердечки
            for (let i = 0; i < 20; i++) {
                ctx.fillStyle = `rgba(255, 92, 131, ${0.08 + Math.random() * 0.3})`;
                drawHeart(ctx, 50 + Math.random() * (c.width - 100), 400 + Math.random() * 400, 12 + Math.random() * 24);
            }

            // Создаем ссылку для скачивания
            const link = document.createElement('a');
            link.download = 'valentine-card.png';
            link.href = c.toDataURL('image/png');
            link.click();

            LogSystem.success('Открытка сгенерирована и скачана');
        }

        function wrapText(ctx, text, x, y, maxWidth, lineHeight) {
            const words = text.split(' ');
            let line = '';

            for (let n = 0; n < words.length; n++) {
                const testLine = line + words[n] + ' ';
                const metrics = ctx.measureText(testLine);
                const testWidth = metrics.width;

                if (testWidth > maxWidth && n > 0) {
                    ctx.fillText(line, x, y);
                    line = words[n] + ' ';
                    y += lineHeight;
                } else {
                    line = testLine;
                }
            }
            ctx.fillText(line, x, y);
        }

        function drawHeart(ctx, x, y, size) {
            ctx.beginPath();
            ctx.moveTo(x, y);
            ctx.bezierCurveTo(x - size / 2, y - size, x - size * 1.2, y + size / 2, x, y + size);
            ctx.bezierCurveTo(x + size * 1.2, y + size / 2, x + size / 2, y - size, x, y);
            ctx.fill();
        }

        // КОНФЕТТИ
        function createConfetti() {
            const confettiContainer = document.getElementById('confetti');
            const colors = ['#ff3366', '#ff6699', '#ff9966', '#ffcc00', '#66ccff', '#b399ff'];

            for (let i = 0; i < 100; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = `${Math.random() * 100}vw`;
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.width = `${Math.random() * 10 + 5}px`;
                piece.style.height = `${Math.random() * 10 + 5}px`;
                piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';

                confettiContainer.appendChild(piece);

                // Анимация падения
                const animation = piece.animate([
                    { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
                    { transform: `translateY(100vh) rotate(${Math.random() * 360}deg)`, opacity: 0 }
                ], {
                    duration: Math.random() * 3000 + 2000,
                    easing: 'cubic-bezier(0.2, 0, 0.8, 1)'
                });

                animation.onfinish = () => piece.remove();
            }
        }

        function createConfettiAtElement(element) {
            const rect = element.getBoundingClientRect();
            const confettiContainer = document.getElementById('confetti');
            const colors = ['#ff3366', '#ff6699', '#ff9966', '#ffcc00', '#66ccff', '#b399ff'];

            for (let i = 0; i < 50; i++) {
                const piece = document.createElement('div');
                piece.className = 'confetti-piece';
                piece.style.left = `${rect.left + Math.random() * rect.width}px`;
                piece.style.top = `${rect.top + Math.random() * rect.height}px`;
                piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                piece.style.width = `${Math.random() * 8 + 4}px`;
                piece.style.height = `${Math.random() * 8 + 4}px`;

                confettiContainer.appendChild(piece);

                // Анимация разлета
                const angle = Math.random() * Math.PI * 2;
                const distance = 100 + Math.random() * 200;

                piece.animate([
                    { transform: 'scale(1) rotate(0deg)', opacity: 1 },
                    { transform: `translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px) scale(0) rotate(360deg)`, opacity: 0 }
                ], {
                    duration: Math.random() * 2000 + 1000,
                    easing: 'cubic-bezier(0.2, 0, 0.8, 1)'
                }).onfinish = () => piece.remove();
            }
        }

        // ЗВУКИ
        function playSound(type) {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();

                if (type === 'success') {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1);
                    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2);

                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.5);
                }
                else if (type === 'error') {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(220, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(196, audioContext.currentTime + 0.1);

                    gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.3);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                }
                else if (type === 'tap') {
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();

                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);

                    oscillator.frequency.setValueAtTime(440, audioContext.currentTime);

                    gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.1);

                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                }
            } catch (e) {
                LogSystem.warning('Аудио не поддерживается: ' + e.message);
            }
        }

        // ЗАПУСК
        document.addEventListener('DOMContentLoaded', init);

        // Решение проблемы с клавиатурой на мобильных
        document.addEventListener('touchstart', function() {
            if (document.activeElement === passwordInput) {
                setTimeout(() => {
                    passwordInput.focus();
                }, 100);
            }
        });
    </script>
</body>
</html>
